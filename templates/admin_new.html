{% extends "base.html" %}

{% block title %}Admin - Event Management{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 pb-20" x-data="adminApp()">
    <!-- Main Content Area -->
    <div class="max-w-md mx-auto bg-white min-h-screen">
        
        <!-- Header -->
        <div class="p-4 border-b border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-xl font-semibold text-gray-800">Admin</h1>
                    <p class="text-sm text-gray-600">Manage events</p>
                </div>
                <div class="flex space-x-3">
                    <a href="/admin/table" class="text-blue-600 text-sm font-medium">📊 Table View</a>
                    <a href="/admin/rss-feeds" class="text-blue-600 text-sm font-medium">📡 RSS Feeds</a>
                    <a href="/admin/web-scrapers" class="text-blue-600 text-sm font-medium">🕷️ Web Scrapers</a>
                    <a href="/" class="text-blue-600 text-sm font-medium">View Public</a>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="flex space-x-2">
                <button @click="showAddEventModal = true" 
                        class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium touch-manipulation">
                    + Add Event
                </button>
                <button @click="showBulkImportModal = true" 
                        class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium touch-manipulation">
                    📥 Import
                </button>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="border-b border-gray-200">
            <div class="flex">
                <button @click="activeTab = 'events'" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'events', 'border-transparent text-gray-500': activeTab !== 'events'}"
                        class="flex-1 py-3 px-4 text-center border-b-2 font-medium text-sm touch-manipulation">
                    📅 Events
                </button>
                <button @click="activeTab = 'scraper'" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'scraper', 'border-transparent text-gray-500': activeTab !== 'scraper'}"
                        class="flex-1 py-3 px-4 text-center border-b-2 font-medium text-sm touch-manipulation">
                    🤖 Scraper
                </button>
                <button @click="activeTab = 'map'" 
                        :class="{'border-blue-500 text-blue-600': activeTab === 'map', 'border-transparent text-gray-500': activeTab !== 'map'}"
                        class="flex-1 py-3 px-4 text-center border-b-2 font-medium text-sm touch-manipulation">
                    📍 Map
                </button>
            </div>
        </div>
        
        <!-- Tab Content -->
        <div class="flex-1 overflow-y-auto">
            <!-- Events View (Default) -->
            <div x-show="activeTab === 'events'" class="p-4">
                <div class="mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">All Events</h2>
                    <p class="text-sm text-gray-600" x-text="`${events.length} events total`"></p>
                </div>
                
                <!-- Events List -->
                <div class="space-y-3">
                    <template x-for="event in sortedEvents" :key="event.id">
                        <div class="border border-gray-200 rounded-lg p-3">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <div class="text-sm font-medium text-gray-900" x-text="formatTimeRange(event)"></div>
                                        <div x-show="event.category_color" 
                                             class="w-3 h-3 rounded-full" 
                                             :style="'background-color: ' + event.category_color"></div>
                                    </div>
                                    <div class="text-sm font-medium text-gray-900 mb-1" x-text="event.title"></div>
                                    <div x-show="event.location_name || event.address" class="text-xs text-gray-500 mb-1">
                                        <div x-show="event.location_name" class="font-medium" x-text="event.location_name"></div>
                                        <div x-show="event.address" class="text-gray-600" x-text="event.address"></div>
                                    </div>
                                    <div x-show="event.url" class="text-xs text-blue-600 mb-1">
                                        <a :href="event.url" target="_blank" class="hover:underline flex items-center">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                            </svg>
                                            <span class="truncate" x-text="event.url"></span>
                                        </a>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-gray-400" x-text="formatDate(event.start_datetime)"></span>
                                        <span x-show="event.price_info" class="text-xs px-2 py-1 rounded-full"
                                              :class="event.price_info === 'Free' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'"
                                              x-text="event.price_info"></span>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-1 ml-2">
                                    <button @click="editEvent(event)" 
                                            class="p-1 text-gray-400 hover:text-blue-600 touch-manipulation">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                    <button @click="deleteEvent(event.id)" 
                                            class="p-1 text-gray-400 hover:text-red-600 touch-manipulation">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <!-- Empty State -->
                <div x-show="events.length === 0" class="text-center py-12">
                    <div class="text-gray-400 text-4xl mb-4">📅</div>
                    <p class="text-gray-500 mb-4">No events yet</p>
                    <button @click="showAddEventModal = true" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium touch-manipulation">
                        Add Your First Event
                    </button>
                </div>
            </div>
            
            <!-- Scraper View -->
            <div x-show="activeTab === 'scraper'" class="p-4">
                <div class="mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">🤖 Automated Event Scraper</h2>
                    <p class="text-sm text-gray-600">Monitor websites and automatically discover events</p>
                </div>
                
                <!-- Add URL Section -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="text-sm font-medium text-blue-900 mb-3">Add New URL to Monitor</h3>
                    <div class="space-y-3">
                        <div>
                            <input type="url" x-model="newUrl.url" 
                                   placeholder="https://example.com/events"
                                   class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <input type="text" x-model="newUrl.name" 
                                       placeholder="Friendly name (optional)"
                                       class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div>
                                <select x-model="newUrl.frequency" 
                                        class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    <option value="hourly">Every Hour</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                </select>
                            </div>
                        </div>
                        <button @click="addMonitoredUrl()" 
                                :disabled="!newUrl.url.trim() || addingUrl"
                                :class="!newUrl.url.trim() || addingUrl ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'"
                                class="w-full px-4 py-2 rounded-md text-sm font-medium transition-colors">
                            <span x-show="!addingUrl">Add URL</span>
                            <span x-show="addingUrl">Adding...</span>
                        </button>
                    </div>
                </div>
                
                <!-- Monitored URLs List -->
                <div class="mb-6">
                    <h3 class="text-sm font-medium text-gray-800 mb-3">Monitored URLs</h3>
                    <div class="space-y-2">
                        <template x-for="url in monitoredUrls" :key="url.id">
                            <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-2">
                                        <div class="text-sm font-medium text-gray-900" x-text="url.name || url.url"></div>
                                        <span x-show="url.enabled" class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full">Active</span>
                                        <span x-show="!url.enabled" class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded-full">Disabled</span>
                                    </div>
                                    <div class="text-xs text-gray-500 truncate" x-text="url.url"></div>
                                    <div class="text-xs text-gray-400" x-text="'Last scraped: ' + (url.last_scraped || 'Never')"></div>
                                </div>
                                <div class="flex items-center space-x-1 ml-2">
                                    <button @click="toggleUrl(url)" 
                                            class="p-1 text-gray-400 hover:text-blue-600 touch-manipulation">
                                        <svg x-show="url.enabled" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <svg x-show="!url.enabled" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                    <button @click="deleteUrl(url.id)" 
                                            class="p-1 text-gray-400 hover:text-red-600 touch-manipulation">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Empty State -->
                        <div x-show="monitoredUrls.length === 0" class="text-center py-8">
                            <div class="text-gray-400 text-4xl mb-2">🤖</div>
                            <p class="text-gray-500 text-sm">No URLs being monitored yet</p>
                            <p class="text-gray-400 text-xs">Add a URL above to start automated event discovery</p>
                        </div>
                    </div>
                </div>
                
                <!-- Manual Scrape Button -->
                <div class="mb-6">
                    <button @click="runScraper()" 
                            :disabled="runningScraper || monitoredUrls.length === 0"
                            :class="runningScraper || monitoredUrls.length === 0 ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'"
                            class="w-full px-4 py-3 rounded-lg text-sm font-medium transition-colors">
                        <span x-show="!runningScraper">🚀 Run Scraper Now</span>
                        <span x-show="runningScraper">⏳ Scraping...</span>
                    </button>
                </div>
                
                <!-- Pending Events -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-medium text-gray-800">Pending Events</h3>
                        <span class="text-xs text-gray-500" x-text="`${pendingEvents.length} events awaiting review`"></span>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        <template x-for="event in pendingEvents" :key="event.id">
                            <div class="p-3 bg-white border border-gray-200 rounded-lg">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-medium text-gray-900 mb-1" x-text="event.title"></div>
                                        <div class="text-xs text-gray-500 mb-1" x-text="event.source_name"></div>
                                        <div class="text-xs text-gray-400" x-text="event.start_datetime"></div>
                                        <div x-show="event.location_name || event.address" class="text-xs text-gray-500">
                                            <div x-show="event.location_name" class="font-medium" x-text="event.location_name"></div>
                                            <div x-show="event.address" class="text-gray-600" x-text="event.address"></div>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-1 ml-2">
                                        <button @click="approveEvent(event.id)" 
                                                class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                            ✓
                                        </button>
                                        <button @click="rejectEvent(event.id)" 
                                                class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                            ✗
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Empty State -->
                        <div x-show="pendingEvents.length === 0" class="text-center py-4">
                            <div class="text-gray-400 text-2xl mb-1">📋</div>
                            <p class="text-gray-500 text-xs">No pending events</p>
                        </div>
                    </div>
                </div>
                
                <!-- Activity Log -->
                <div>
                    <h3 class="text-sm font-medium text-gray-800 mb-3">Activity Log</h3>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 max-h-48 overflow-y-auto">
                        <div class="space-y-2">
                            <template x-for="log in activityLogs" :key="log.id">
                                <div class="flex items-start space-x-2 text-xs">
                                    <div class="flex-shrink-0 w-2 h-2 rounded-full mt-1.5"
                                         :class="log.status === 'success' ? 'bg-green-500' : log.status === 'error' ? 'bg-red-500' : 'bg-yellow-500'"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-gray-900" x-text="log.message"></div>
                                        <div class="text-gray-500" x-text="log.created_at"></div>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Empty State -->
                            <div x-show="activityLogs.length === 0" class="text-center py-4">
                                <div class="text-gray-400 text-lg mb-1">📊</div>
                                <p class="text-gray-500 text-xs">No activity yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Calendar View -->
            <div x-show="activeTab === 'calendar'" class="p-4">
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <button @click="previousMonth()" class="p-2 hover:bg-gray-100 rounded-full touch-manipulation">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        <h2 class="text-lg font-semibold text-gray-800" x-text="currentMonthYear"></h2>
                        <button @click="nextMonth()" class="p-2 hover:bg-gray-100 rounded-full touch-manipulation">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        <div class="text-center text-xs font-medium text-gray-500 py-2">S</div>
                        <div class="text-center text-xs font-medium text-gray-500 py-2">M</div>
                        <div class="text-center text-xs font-medium text-gray-500 py-2">T</div>
                        <div class="text-center text-xs font-medium text-gray-500 py-2">W</div>
                        <div class="text-center text-xs font-medium text-gray-500 py-2">T</div>
                        <div class="text-center text-xs font-medium text-gray-500 py-2">F</div>
                        <div class="text-center text-xs font-medium text-gray-500 py-2">S</div>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-1">
                        <template x-for="day in calendarDays" :key="day.date">
                            <button @click="selectDate(day.date)"
                                    :class="{
                                        'bg-blue-500 text-white shadow-md': day.isSelected,
                                        'bg-gray-100 hover:bg-gray-200': !day.isSelected && day.isCurrentMonth,
                                        'text-gray-400': !day.isCurrentMonth,
                                        'text-gray-800': day.isCurrentMonth && !day.isSelected
                                    }"
                                    class="w-full h-10 rounded-lg text-sm font-medium transition-all duration-200 relative touch-manipulation focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                                    :disabled="!day.isCurrentMonth">
                                <span x-text="day.dayNumber"></span>
                                <div x-show="day.hasEvents" 
                                     class="absolute bottom-1 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 rounded-full"
                                     :class="day.isSelected ? 'bg-white' : 'bg-blue-500'"></div>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
            
            <!-- Map View -->
            <div x-show="activeTab === 'map'" class="p-4">
                <div class="mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-2">Events on Map</h2>
                    <p class="text-sm text-gray-600" x-text="`${eventsWithLocations.length} events with locations`"></p>
                </div>
                
                <!-- Map Placeholder -->
                <div class="bg-gray-100 rounded-lg h-64 flex items-center justify-center mb-4">
                    <div class="text-center">
                        <div class="text-gray-400 text-4xl mb-2">🗺️</div>
                        <p class="text-gray-500 text-sm">Interactive map coming soon</p>
                    </div>
                </div>
                
                <!-- Events with Locations -->
                <div class="space-y-2">
                    <template x-for="event in eventsWithLocations" :key="event.id">
                        <div class="border border-gray-200 rounded-lg p-3">
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-gray-900 mb-1" x-text="event.title"></div>
                                    <div x-show="event.location_name || event.address" class="text-xs text-gray-500 mb-1">
                                        <div x-show="event.location_name" class="font-medium" x-text="event.location_name"></div>
                                        <div x-show="event.address" class="text-gray-600" x-text="event.address"></div>
                                    </div>
                                    <div class="text-xs text-gray-400" x-text="formatDate(event.start_datetime) + ' at ' + formatTimeRange(event)"></div>
                                </div>
                                <div class="flex items-center space-x-1 ml-2">
                                    <button @click="editEvent(event)" 
                                            class="p-1 text-gray-400 hover:text-blue-600 touch-manipulation">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
                
                <div x-show="eventsWithLocations.length === 0" class="text-center py-12">
                    <div class="text-gray-400 text-4xl mb-4">📍</div>
                    <p class="text-gray-500">No events with locations</p>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Add/Edit Event Modal -->
    <div x-show="showAddEventModal || showEditEventModal" 
         x-cloak
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
         @click.self="closeModal()">
        <div class="relative top-4 mx-auto p-4 border w-11/12 max-w-lg shadow-lg rounded-md bg-white">
            <div class="mb-4">
                <h3 class="text-lg font-medium text-gray-900" x-text="showAddEventModal ? 'Add New Event' : 'Edit Event'"></h3>
                <p class="text-sm text-gray-600">Fill in the event details below or use smart parsing</p>
            </div>
            
            <!-- Smart Parse Section -->
            <div x-show="showAddEventModal" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-medium text-blue-900">🤖 Smart Event Parser</h4>
                    <button type="button" @click="showParseSection = !showParseSection" 
                            class="text-blue-600 text-xs font-medium">
                        <span x-text="showParseSection ? 'Hide' : 'Show'"></span>
                    </button>
                </div>
                <p class="text-xs text-blue-700 mb-3">Paste unstructured event text and let AI extract the details automatically.</p>
                
                <div x-show="showParseSection" class="space-y-3">
                    <textarea x-model="parseInput" 
                              placeholder="Example: Team meeting with Sam at 10am next Wednesday in Zoom conference room. We'll discuss the Q4 project timeline and budget allocation."
                              class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                              rows="3"></textarea>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <button type="button" @click="parseEventText()" 
                                    :disabled="!parseInput.trim() || isParsing"
                                    :class="!parseInput.trim() || isParsing ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'"
                                    class="px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                <span x-show="!isParsing">Parse Event</span>
                                <span x-show="isParsing">Parsing...</span>
                            </button>
                            <button type="button" @click="clearParser()" 
                                    class="px-3 py-2 text-sm text-gray-600 hover:text-gray-800">
                                Clear
                            </button>
                        </div>
                        <div x-show="parseResult" class="text-xs text-green-600 font-medium">
                            ✓ Parsed successfully
                        </div>
                    </div>
                    
                    <!-- Parser Result Preview -->
                    <div x-show="parseResult" 
                         class="p-3 bg-white border border-green-200 rounded-md">
                        <div class="text-xs font-medium text-green-800 mb-2">Parsed Results:</div>
                        <div class="space-y-1 text-xs">
                            <div><span class="font-medium">Title:</span> <span x-text="parseResult?.title || 'Not detected'"></span></div>
                            <div><span class="font-medium">Date:</span> <span x-text="parseResult?.date || 'Not detected'"></span></div>
                            <div><span class="font-medium">Time:</span> <span x-text="parseResult?.time || 'Not detected'"></span></div>
                            <div><span class="font-medium">Location:</span> <span x-text="parseResult?.location || 'Not detected'"></span></div>
                            <div><span class="font-medium">Price:</span> <span x-text="parseResult?.price || 'Not detected'"></span></div>
                            <div><span class="font-medium">URL:</span> <span x-text="parseResult?.url || 'Not detected'"></span></div>
                        </div>
                        <button type="button" @click="applyParsedData()" 
                                class="mt-2 px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                            Apply to Form
                        </button>
                    </div>
                </div>
            </div>
            
            <form @submit.prevent="saveEvent()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Event Title *</label>
                        <input type="text" x-model="eventForm.title" required
                               placeholder="Enter a short, punchy name for your event"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                            <input type="date" x-model="eventForm.date" required
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Start Time *</label>
                            <div class="flex gap-2">
                                <input type="number" x-model="eventForm.hour" min="1" max="12" required
                                       class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                       placeholder="Hour">
                                <span class="text-gray-500 self-center">:</span>
                                <input type="number" x-model="eventForm.minute" min="0" max="59" required
                                       class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                       placeholder="Min">
                                <select x-model="eventForm.ampm" required
                                        class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">End Time (Optional)</label>
                            <div class="flex gap-2">
                                <input type="number" x-model="eventForm.endHour" min="1" max="12"
                                       class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                       placeholder="Hour">
                                <span class="text-gray-500 self-center">:</span>
                                <input type="number" x-model="eventForm.endMinute" min="0" max="59"
                                       class="flex-1 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                       placeholder="Min">
                                <select x-model="eventForm.endAmpm"
                                        class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                        <div class="space-y-2">
                            <input type="text" x-model="eventForm.location_name"
                                   placeholder="Location name (e.g., The Royal Embassy of Saudi Arabia)"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                            
                            <div class="relative">
                                <input type="text" x-model="eventForm.address"
                                       placeholder="Address (e.g., 601 New Hampshire Avenue, NW, Washington, DC)"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"
                                       @input="searchAddresses()"
                                       @focus="showAddressSuggestions = true"
                                       @blur="setTimeout(() => showAddressSuggestions = false, 200)">
                                
                                <!-- Address Suggestions Dropdown -->
                                <div x-show="showAddressSuggestions && addressSuggestions.length > 0" 
                                     class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-48 overflow-y-auto">
                                    <template x-for="suggestion in addressSuggestions" :key="suggestion">
                                        <div @click="selectAddress(suggestion)" 
                                             class="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100 last:border-b-0"
                                             x-text="suggestion"></div>
                                    </template>
                                </div>
                                    </div>
                            
                            <!-- Combined Location Display -->
                            <div x-show="eventForm.location_name || eventForm.address" class="text-xs text-gray-500 bg-gray-50 p-2 rounded">
                                <div x-show="eventForm.location_name" class="font-medium" x-text="eventForm.location_name"></div>
                                <div x-show="eventForm.address" class="text-gray-600" x-text="eventForm.address"></div>
                            </div>
                        </div>
                    </div>
                    
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Price Information</label>
                        <input type="text" x-model="eventForm.price_info" placeholder="e.g., Free, $25, Free; $25"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Event URL</label>
                        <input type="url" x-model="eventForm.url" placeholder="https://example.com/event"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <p class="text-xs text-gray-500 mt-1">Optional: Link to event details, registration, or more information</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea x-model="eventForm.description" rows="3"
                                  placeholder="Provide more details about the event..."
                                  class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"></textarea>
                    </div>
                </div>
                
                <div class="flex space-x-3 mt-6">
                    <button type="button" @click="closeModal()"
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm touch-manipulation">
                        Cancel
                    </button>
                    <button type="submit" :disabled="saving"
                            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 text-sm touch-manipulation">
                        <span x-show="!saving" x-text="showAddEventModal ? 'Add Event' : 'Update Event'"></span>
                        <span x-show="saving">Saving...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Bulk Import Modal -->
    <div x-show="showBulkImportModal" 
         x-cloak
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
         @click.self="closeBulkImportModal()">
        <div class="relative top-4 mx-auto p-4 border w-11/12 max-w-md shadow-lg rounded-md bg-white">
            <div class="mb-4">
                <h3 class="text-lg font-medium text-gray-900">Bulk Import Events</h3>
            </div>
            
            <div class="space-y-4">
                <!-- Import Type Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Import Type</label>
                    <div class="flex space-x-2">
                        <button @click="importType = 'general'" 
                                :class="importType === 'general' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                class="flex-1 px-3 py-2 rounded-md text-sm font-medium touch-manipulation">
                            General Text
                        </button>
                        <button @click="importType = 'washington_post'" 
                                :class="importType === 'washington_post' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'"
                                class="flex-1 px-3 py-2 rounded-md text-sm font-medium touch-manipulation">
                            Washington Post
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span x-show="importType === 'general'">Paste Event Information</span>
                        <span x-show="importType === 'washington_post'">Paste Washington Post Events File Content</span>
                    </label>
                    <textarea x-model="bulkImportText" rows="8"
                              :placeholder="importType === 'general' ? 'Paste your event information here...' : 'Paste the Washington Post events file content here...'"
                              class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm"></textarea>
                </div>
                
                <div class="flex space-x-2">
                    <button @click="importType === 'general' ? extractEvents() : importWashingtonPostEvents()" 
                            :disabled="!bulkImportText.trim() || extracting"
                            class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 text-sm touch-manipulation">
                        <span x-show="!extracting">
                            <span x-show="importType === 'general'">Extract Events</span>
                            <span x-show="importType === 'washington_post'">Import WP Events</span>
                        </span>
                        <span x-show="extracting">Processing...</span>
                    </button>
                    <button @click="clearBulkImport()" 
                            class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 text-sm touch-manipulation">
                        Clear
                    </button>
                </div>
            </div>
            
            <div class="flex space-x-3 mt-6">
                <button @click="closeBulkImportModal()"
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm touch-manipulation">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifications -->
    <div class="fixed top-4 right-4 z-50 space-y-2">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.show" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform translate-x-full"
                 x-transition:enter-end="opacity-100 transform translate-x-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 transform translate-x-0"
                 x-transition:leave-end="opacity-0 transform translate-x-full"
                 :class="{
                     'bg-green-50 border-green-200 text-green-800': toast.type === 'success',
                     'bg-red-50 border-red-200 text-red-800': toast.type === 'error',
                     'bg-blue-50 border-blue-200 text-blue-800': toast.type === 'info'
                 }"
                 class="max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden border">
                <div class="p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div x-show="toast.type === 'success'" class="text-green-400">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div x-show="toast.type === 'error'" class="text-red-400">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div x-show="toast.type === 'info'" class="text-blue-400">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-3 w-0 flex-1 pt-0.5">
                            <p class="text-sm font-medium" x-text="toast.message"></p>
                        </div>
                        <div class="ml-4 flex-shrink-0 flex">
                            <button @click="removeToast(toast.id)" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <span class="sr-only">Close</span>
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200">
        <div class="max-w-md mx-auto">
            <div class="grid grid-cols-4">
                <!-- Events Tab -->
                <button class="flex flex-col items-center py-3 text-blue-600 touch-manipulation">
                    <div class="text-xl mb-1">📅</div>
                    <div class="text-xs font-medium">Events</div>
                </button>
                
                <!-- Stats Tab -->
                <button class="flex flex-col items-center py-3 text-gray-400 touch-manipulation">
                    <div class="text-xl mb-1">📊</div>
                    <div class="text-xs font-medium">Stats</div>
                </button>
                
                <!-- Settings Tab -->
                <button class="flex flex-col items-center py-3 text-gray-400 touch-manipulation">
                    <div class="text-xl mb-1">⚙️</div>
                    <div class="text-xs font-medium">Settings</div>
                </button>
                
                <!-- Logout Tab -->
                <a href="/admin/logout" class="flex flex-col items-center py-3 text-gray-400 touch-manipulation">
                    <div class="text-xl mb-1">🚪</div>
                    <div class="text-xs font-medium">Logout</div>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function adminApp() {
    return {
        events: [],
        loading: false,
        showAddEventModal: false,
        showEditEventModal: false,
        showBulkImportModal: false,
        editingEventId: null,
        saving: false,
        _activeTab: 'events',
        currentDate: new Date(),
        selectedDate: null,
        bulkImportText: '',
        importType: 'general',
        extracting: false,
        toasts: [],
        locationPreviewMap: null,
        showAddressSuggestions: false,
        addressSuggestions: [],
        // Parser-related properties
        showParseSection: false,
        parseInput: '',
        parseResult: null,
        isParsing: false,
        // Scraper-related properties
        monitoredUrls: [],
        pendingEvents: [],
        activityLogs: [],
        newUrl: {
            url: '',
            name: '',
            frequency: 'daily'
        },
        addingUrl: false,
        runningScraper: false,
        eventForm: {
            title: '',
            date: '',
            hour: '',
            minute: '',
            ampm: 'AM',
            endHour: '',
            endMinute: '',
            endAmpm: 'AM',
            location: '',
            location_name: '',
            address: '',
            price_info: '',
            url: '',
            description: ''
        },
        
        get sortedEvents() {
            return this.events.sort((a, b) => new Date(a.start_datetime) - new Date(b.start_datetime));
        },
        
        get eventsWithLocations() {
            return this.events.filter(event => 
                (event.location && event.location.trim() !== '') ||
                (event.location_name && event.location_name.trim() !== '') ||
                (event.address && event.address.trim() !== '')
            );
        },
        
        get currentMonthYear() {
            return this.currentDate.toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
        },
        
        get calendarDays() {
            const year = this.currentDate.getFullYear();
            const month = this.currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const days = [];
            const today = new Date();
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dateStr = date.toISOString().split('T')[0];
                const dayEvents = this.events.filter(event => 
                    event.start_datetime.startsWith(dateStr)
                );
                
                days.push({
                    date: dateStr,
                    dayNumber: date.getDate(),
                    isCurrentMonth: date.getMonth() === month,
                    isToday: date.toDateString() === today.toDateString(),
                    isSelected: this.selectedDate === dateStr,
                    hasEvents: dayEvents.length > 0,
                    eventCount: dayEvents.length
                });
            }
            
            return days;
        },
        
        async loadEvents() {
            this.loading = true;
            try {
                const response = await fetch('/api/events');
                this.events = await response.json();
            } catch (error) {
                console.error('Error loading events:', error);
            } finally {
                this.loading = false;
            }
        },
        
        async saveEvent() {
            this.saving = true;
            try {
                // Convert AM/PM format to 24-hour format for start time
                let hour24 = parseInt(this.eventForm.hour);
                if (this.eventForm.ampm === 'AM' && hour24 === 12) {
                    hour24 = 0;
                } else if (this.eventForm.ampm === 'PM' && hour24 !== 12) {
                    hour24 += 12;
                }
                
                const startTime24 = `${hour24.toString().padStart(2, '0')}:${this.eventForm.minute.padStart(2, '0')}`;
                
                // Convert AM/PM format to 24-hour format for end time (if provided)
                let endDatetime = '';
                if (this.eventForm.endHour && this.eventForm.endMinute) {
                    let endHour24 = parseInt(this.eventForm.endHour);
                    if (this.eventForm.endAmpm === 'AM' && endHour24 === 12) {
                        endHour24 = 0;
                    } else if (this.eventForm.endAmpm === 'PM' && endHour24 !== 12) {
                        endHour24 += 12;
                    }
                    
                    const endTime24 = `${endHour24.toString().padStart(2, '0')}:${this.eventForm.endMinute.padStart(2, '0')}`;
                    endDatetime = `${this.eventForm.date}T${endTime24}:00`;
                }
                
                const eventData = {
                    ...this.eventForm,
                    start_datetime: `${this.eventForm.date}T${startTime24}:00`,
                    end_datetime: endDatetime
                };
                
                const url = this.showAddEventModal ? '/api/events' : `/api/events/${this.editingEventId}`;
                const method = this.showAddEventModal ? 'POST' : 'PUT';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(eventData)
                });
                
                if (response.ok) {
                    await this.loadEvents();
                    this.closeModal();
                    const message = this.showAddEventModal ? 'Event created successfully!' : 'Event updated successfully!';
                    this.showToast(message, 'success');
                } else {
                    this.showToast('Error saving event. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error saving event:', error);
                this.showToast('Error saving event. Please try again.', 'error');
            } finally {
                this.saving = false;
            }
        },
        
        async deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event?')) return;
            
            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await this.loadEvents();
                    this.showToast('Event deleted successfully!', 'success');
                } else {
                    this.showToast('Error deleting event. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error deleting event:', error);
                this.showToast('Error deleting event. Please try again.', 'error');
            }
        },
        
        editEvent(event) {
            this.editingEventId = event.id;
            
            // Convert 24-hour time to AM/PM format for start time
            const eventDate = new Date(event.start_datetime);
            let hour = eventDate.getHours();
            const minute = eventDate.getMinutes();
            let ampm = 'AM';
            
            if (hour === 0) {
                hour = 12;
            } else if (hour === 12) {
                ampm = 'PM';
            } else if (hour > 12) {
                hour = hour - 12;
                ampm = 'PM';
            }
            
            // Convert 24-hour time to AM/PM format for end time (if exists)
            let endHour = '';
            let endMinute = '';
            let endAmpm = 'AM';
            
            if (event.end_datetime) {
                const endDate = new Date(event.end_datetime);
                let endHour24 = endDate.getHours();
                const endMinute24 = endDate.getMinutes();
                
                if (endHour24 === 0) {
                    endHour = '12';
                } else if (endHour24 === 12) {
                    endHour = '12';
                    endAmpm = 'PM';
                } else if (endHour24 > 12) {
                    endHour = (endHour24 - 12).toString();
                    endAmpm = 'PM';
                } else {
                    endHour = endHour24.toString();
                }
                
                endMinute = endMinute24.toString().padStart(2, '0');
            }
            
            this.eventForm = {
                title: event.title,
                date: event.start_datetime.split('T')[0],
                hour: hour.toString(),
                minute: minute.toString().padStart(2, '0'),
                ampm: ampm,
                endHour: endHour,
                endMinute: endMinute,
                endAmpm: endAmpm,
                location: event.location || '',
                location_name: event.location_name || '',
                address: event.address || '',
                price_info: event.price_info || '',
                url: event.url || '',
                description: event.description || ''
            };
            this.showEditEventModal = true;
        },
        
        closeModal() {
            this.showAddEventModal = false;
            this.showEditEventModal = false;
            this.editingEventId = null;
            this.eventForm = {
                title: '',
                date: this.getCurrentDate(),
                hour: '',
                minute: '',
                ampm: 'AM',
                endHour: '',
                endMinute: '',
                endAmpm: 'AM',
                location: '',
                location_name: '',
                address: '',
                price_info: '',
                url: '',
                description: ''
            };
            this.destroyLocationPreviewMap();
            this.clearParser();
        },
        
        // Parser Functions
        async parseEventText() {
            if (!this.parseInput.trim()) return;
            
            this.isParsing = true;
            this.parseResult = null;
            
            try {
                const response = await fetch('/api/ai/parse-event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: this.parseInput
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    this.parseResult = result;
                    this.showToast('Event parsed successfully!', 'success');
                } else {
                    throw new Error('Failed to parse event');
                }
            } catch (error) {
                console.error('Error parsing event:', error);
                this.showToast('Error parsing event. Please try again.', 'error');
            } finally {
                this.isParsing = false;
            }
        },
        
        applyParsedData() {
            if (!this.parseResult || typeof this.parseResult !== 'object') {
                this.showToast('No parsed data to apply', 'error');
                return;
            }
            
            // Apply parsed data to form
            if (this.parseResult.title) {
                this.eventForm.title = this.parseResult.title;
            }
            
            if (this.parseResult.date) {
                this.eventForm.date = this.parseResult.date;
            }
            
            if (this.parseResult.time) {
                // Parse time from 24-hour format to AM/PM format
                const timeParts = this.parseResult.time.split(':');
                if (timeParts.length >= 2) {
                    let hour = parseInt(timeParts[0]);
                    const minute = timeParts[1];
                    
                    if (hour === 0) {
                        hour = 12;
                        this.eventForm.ampm = 'AM';
                    } else if (hour < 12) {
                        this.eventForm.ampm = 'AM';
                    } else if (hour === 12) {
                        this.eventForm.ampm = 'PM';
                    } else {
                        hour = hour - 12;
                        this.eventForm.ampm = 'PM';
                    }
                    
                    this.eventForm.hour = hour.toString();
                    this.eventForm.minute = minute;
                }
            }
            
            // Handle end time if available
            if (this.parseResult.end_time) {
                const endTimeParts = this.parseResult.end_time.split(':');
                if (endTimeParts.length >= 2) {
                    let endHour = parseInt(endTimeParts[0]);
                    const endMinute = endTimeParts[1];
                    
                    if (endHour === 0) {
                        endHour = 12;
                        this.eventForm.endAmpm = 'AM';
                    } else if (endHour < 12) {
                        this.eventForm.endAmpm = 'AM';
                    } else if (endHour === 12) {
                        this.eventForm.endAmpm = 'PM';
                    } else {
                        endHour = endHour - 12;
                        this.eventForm.endAmpm = 'PM';
                    }
                    
                    this.eventForm.endHour = endHour.toString();
                    this.eventForm.endMinute = endMinute;
                }
            }
            
            if (this.parseResult.location) {
                // Try to parse location into name and address
                const location = this.parseResult.location;
                
                // Check if it looks like an address (contains numbers and street indicators)
                const addressPattern = /\d+\s+[A-Za-z\s,.-]+(?:Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Drive|Dr|Lane|Ln|Way|Place|Pl|Court|Ct|NW|NE|SW|SE)/i;
                
                if (addressPattern.test(location)) {
                    // It's an address
                    this.eventForm.address = location;
                } else {
                    // It's a location name
                    this.eventForm.location_name = location;
                }
                
                // Keep the original location field for backward compatibility
                this.eventForm.location = location;
            }
            
            if (this.parseResult.description) {
                this.eventForm.description = this.parseResult.description;
            }
            
            if (this.parseResult.price) {
                this.eventForm.price_info = this.parseResult.price;
            }
            
            
            if (this.parseResult.url) {
                this.eventForm.url = this.parseResult.url;
            }
            
            this.showToast('Parsed data applied to form!', 'success');
            this.clearParser();
        },
        
        clearParser() {
            this.parseInput = '';
            this.parseResult = null;
            this.isParsing = false;
        },
        
        // Scraper Functions
        async loadScraperData() {
            try {
                // Load monitored URLs
                const urlsResponse = await fetch('/api/scraper/urls');
                if (urlsResponse.ok) {
                    this.monitoredUrls = await urlsResponse.json();
                }
                
                // Load pending events
                const eventsResponse = await fetch('/api/scraper/events?status=pending');
                if (eventsResponse.ok) {
                    this.pendingEvents = await eventsResponse.json();
                }
                
                // Load activity logs
                const logsResponse = await fetch('/api/scraper/logs?limit=20');
                if (logsResponse.ok) {
                    this.activityLogs = await logsResponse.json();
                }
            } catch (error) {
                console.error('Error loading scraper data:', error);
            }
        },
        
        async addMonitoredUrl() {
            if (!this.newUrl.url.trim()) return;
            
            this.addingUrl = true;
            try {
                const response = await fetch('/api/scraper/urls', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.newUrl)
                });
                
                if (response.ok) {
                    this.showToast('URL added successfully!', 'success');
                    this.newUrl = { url: '', name: '', frequency: 'daily' };
                    await this.loadScraperData();
                } else {
                    const error = await response.json();
                    this.showToast(error.error || 'Failed to add URL', 'error');
                }
            } catch (error) {
                console.error('Error adding URL:', error);
                this.showToast('Error adding URL', 'error');
            } finally {
                this.addingUrl = false;
            }
        },
        
        async toggleUrl(url) {
            try {
                const response = await fetch(`/api/scraper/urls/${url.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: url.name,
                        enabled: !url.enabled,
                        scrape_frequency: url.scrape_frequency
                    })
                });
                
                if (response.ok) {
                    await this.loadScraperData();
                    this.showToast(`URL ${url.enabled ? 'disabled' : 'enabled'}`, 'success');
                } else {
                    this.showToast('Failed to update URL', 'error');
                }
            } catch (error) {
                console.error('Error toggling URL:', error);
                this.showToast('Error updating URL', 'error');
            }
        },
        
        async deleteUrl(urlId) {
            if (!confirm('Are you sure you want to delete this URL?')) return;
            
            try {
                const response = await fetch(`/api/scraper/urls/${urlId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    this.showToast('URL deleted successfully', 'success');
                    await this.loadScraperData();
                } else {
                    this.showToast('Failed to delete URL', 'error');
                }
            } catch (error) {
                console.error('Error deleting URL:', error);
                this.showToast('Error deleting URL', 'error');
            }
        },
        
        async runScraper() {
            this.runningScraper = true;
            try {
                const response = await fetch('/api/scraper/run', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    this.showToast('Scraping completed!', 'success');
                    await this.loadScraperData();
                } else {
                    const error = await response.json();
                    this.showToast(error.error || 'Scraping failed', 'error');
                }
            } catch (error) {
                console.error('Error running scraper:', error);
                this.showToast('Error running scraper', 'error');
            } finally {
                this.runningScraper = false;
            }
        },
        
        async approveEvent(eventId) {
            try {
                const response = await fetch(`/api/scraper/events/${eventId}/approve`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    this.showToast('Event approved and added!', 'success');
                    await this.loadScraperData();
                    await this.loadEvents(); // Refresh main events list
                } else {
                    this.showToast('Failed to approve event', 'error');
                }
            } catch (error) {
                console.error('Error approving event:', error);
                this.showToast('Error approving event', 'error');
            }
        },
        
        async rejectEvent(eventId) {
            if (!confirm('Are you sure you want to reject this event?')) return;
            
            try {
                const response = await fetch(`/api/scraper/events/${eventId}/reject`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    this.showToast('Event rejected', 'success');
                    await this.loadScraperData();
                } else {
                    this.showToast('Failed to reject event', 'error');
                }
            } catch (error) {
                console.error('Error rejecting event:', error);
                this.showToast('Error rejecting event', 'error');
            }
        },
        
        
        getCurrentDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        },
        
        // Address suggestion functions
        searchAddresses() {
            const query = this.eventForm.address.toLowerCase().trim();
            if (query.length < 2) {
                this.addressSuggestions = [];
                return;
            }
            
            // Common DC area addresses for suggestions
            const commonAddresses = [
                '601 New Hampshire Avenue, NW, Washington, DC',
                '1600 Pennsylvania Avenue, NW, Washington, DC',
                '1 First Street, SE, Washington, DC',
                '3501 New York Avenue, NE, Washington, DC',
                '1100 Jefferson Drive, SW, Washington, DC',
                '1000 Independence Avenue, SW, Washington, DC',
                '700 Constitution Avenue, NW, Washington, DC',
                '1400 Constitution Avenue, NW, Washington, DC',
                '2000 L Street, NW, Washington, DC',
                '1776 D Street, NW, Washington, DC',
                '800 16th Street, NW, Washington, DC',
                '1200 17th Street, NW, Washington, DC',
                '1000 5th Street, NW, Washington, DC',
                '555 Pennsylvania Avenue, NW, Washington, DC',
                '1300 Pennsylvania Avenue, NW, Washington, DC'
            ];
            
            this.addressSuggestions = commonAddresses.filter(addr => 
                addr.toLowerCase().includes(query)
            ).slice(0, 5);
        },
        
        selectAddress(address) {
            this.eventForm.address = address;
            this.showAddressSuggestions = false;
            this.addressSuggestions = [];
        },
        
        
        showToast(message, type = 'info') {
            const toast = {
                id: Date.now(),
                message: message,
                type: type,
                show: true
            };
            this.toasts.push(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                this.removeToast(toast.id);
            }, 5000);
        },
        
        removeToast(toastId) {
            const index = this.toasts.findIndex(t => t.id === toastId);
            if (index > -1) {
                this.toasts[index].show = false;
                setTimeout(() => {
                    this.toasts.splice(index, 1);
                }, 200);
            }
        },
        
        updateLocationPreview() {
            if (!this.eventForm.location || !this.eventForm.location.trim()) {
                this.destroyLocationPreviewMap();
                return;
            }
            
            // Debounce the geocoding
            clearTimeout(this.locationTimeout);
            this.locationTimeout = setTimeout(() => {
                this.geocodeAndShowLocation(this.eventForm.location);
            }, 500);
        },
        
        async geocodeAndShowLocation(address) {
            try {
                const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=pk.eyJ1IjoicGV0ZXJhbHkiLCJhIjoiY21lNXpuNDhwMTBqZTJwb2RicWw5YWcxaSJ9.IiIfhu1oA2ua_oUDcjlIbQ&limit=1`);
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    const coordinates = data.features[0].center;
                    this.showLocationOnMap(coordinates, address);
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
        },
        
        showLocationOnMap(coordinates, address) {
            this.destroyLocationPreviewMap();
            
            if (typeof mapboxgl === 'undefined') {
                console.error('Mapbox GL JS not loaded');
                return;
            }
            
            this.locationPreviewMap = new mapboxgl.Map({
                container: 'location-preview-map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: coordinates,
                zoom: 15,
                interactive: false
            });
            
            new mapboxgl.Marker()
                .setLngLat(coordinates)
                .addTo(this.locationPreviewMap);
        },
        
        destroyLocationPreviewMap() {
            if (this.locationPreviewMap) {
                this.locationPreviewMap.remove();
                this.locationPreviewMap = null;
            }
        },
        
        selectDate(date) {
            this.selectedDate = date;
            this.activeTab = 'rolodex';
        },
        
        previousMonth() {
            this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 1);
        },
        
        nextMonth() {
            this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 1);
        },
        
        formatDate(datetime) {
            const date = new Date(datetime);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        },
        
        formatTime(datetime) {
            const date = new Date(datetime);
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true
            });
        },
        
        formatTimeRange(event) {
            const startDate = new Date(event.start_datetime);
            const startTime = startDate.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            
            if (event.end_datetime) {
                const endDate = new Date(event.end_datetime);
                const endTime = endDate.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                return `${startTime} - ${endTime}`;
            }
            
            return startTime;
        },
        
        closeBulkImportModal() {
            this.showBulkImportModal = false;
            this.bulkImportText = '';
        },
        
        async extractEvents() {
            this.extracting = true;
            try {
                const response = await fetch('/api/ai/extract-events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        text: this.bulkImportText,
                        method: 'enhanced'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.showToast(`Successfully extracted ${data.count} events!`, 'success');
                    await this.loadEvents();
                    this.closeBulkImportModal();
                } else {
                    this.showToast('Error extracting events. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error extracting events:', error);
                this.showToast('Error extracting events. Please try again.', 'error');
            } finally {
                this.extracting = false;
            }
        },
        
        async importWashingtonPostEvents() {
            this.extracting = true;
            try {
                const response = await fetch('/api/import/washington-post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        content: this.bulkImportText
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.showToast(`Successfully imported ${data.imported} events! (${data.skipped} skipped)`, 'success');
                    await this.loadEvents();
                    this.closeBulkImportModal();
                } else {
                    const errorData = await response.json();
                    this.showToast(`Error importing events: ${errorData.error}`, 'error');
                }
            } catch (error) {
                console.error('Error importing Washington Post events:', error);
                this.showToast('Error importing events. Please try again.', 'error');
            } finally {
                this.extracting = false;
            }
        },
        
        clearBulkImport() {
            this.bulkImportText = '';
        },
        
        formatTime(datetime) {
            const date = new Date(datetime);
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        },
        
        formatDate(datetime) {
            const date = new Date(datetime);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
        },
        
        init() {
            this.loadEvents();
            // Set smart defaults for new events
            this.eventForm.date = this.getCurrentDate();
        },
        
        // Watch for tab changes to load scraper data
        get activeTab() {
            return this._activeTab || 'events';
        },
        
        set activeTab(value) {
            this._activeTab = value;
            if (value === 'scraper') {
                this.loadScraperData();
            }
        }
    }
}
</script>
{% endblock %}
