<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Approval Dashboard - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50" x-data="approvalApp()">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-900">üìã Event Approval Dashboard</h1>
                    <span class="px-3 py-1 bg-yellow-100 text-yellow-800 text-sm font-medium rounded-full">
                        <i class="fas fa-clock mr-1"></i>
                        <span x-text="pendingEvents.length"></span> pending
                    </span>
                </div>
                <div class="flex items-center space-x-4">
                    <button @click="refreshPendingEvents()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync mr-2"></i>
                        Refresh
                    </button>
                    <a href="/admin" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left mr-1"></i>
                        Back to Admin
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <i class="fas fa-clock text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Pending Review</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="pendingEvents.length"></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-bolt text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Very Fresh</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="getFreshEventsCount()"></p>
                        <p class="text-xs text-gray-500">&lt; 1 hour</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-check text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Approved Today</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="approvedToday"></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-red-100 rounded-lg">
                        <i class="fas fa-times text-red-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Rejected Today</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="rejectedToday"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Filters and Sorting -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <!-- Sort by -->
                <div>
                    <label class="block text-sm font-medium mb-1">Sort by</label>
                    <select x-model="sortBy" @change="loadEvents()" class="w-full border rounded px-3 py-2">
                        <option value="event_date">Event Date (Chronological)</option>
                        <option value="source">Source Website</option>
                        <option value="discovery_time">Discovery Time</option>
                        <option value="urgency">Urgency (Soon First)</option>
                        <option value="confidence">Confidence Score</option>
                    </select>
                </div>
                
                <!-- Source filter -->
                <div>
                    <label class="block text-sm font-medium mb-1">Source</label>
                    <select x-model="sourceFilter" @change="loadEvents()" class="w-full border rounded px-3 py-2">
                        <option value="all">All Sources</option>
                        <option value="brookings">Brookings Institution</option>
                        <option value="naturalhistory">Smithsonian Natural History</option>
                        <option value="hirshhorn">Smithsonian Hirshhorn</option>
                        <option value="districtfray">DC Fray Sports</option>
                        <option value="runpacers">Pacers Running</option>
                        <option value="cato">Cato Institute</option>
                    </select>
                </div>
                
                <!-- Date from -->
                <div>
                    <label class="block text-sm font-medium mb-1">From Date</label>
                    <input type="date" x-model="dateFrom" @change="loadEvents()" 
                           class="w-full border rounded px-3 py-2">
                </div>
                
                <!-- Date to -->
                <div>
                    <label class="block text-sm font-medium mb-1">To Date</label>
                    <input type="date" x-model="dateTo" @change="loadEvents()" 
                           class="w-full border rounded px-3 py-2">
                </div>
                
                <!-- Auto-refresh -->
                <div class="flex flex-col justify-end">
                    <label class="flex items-center">
                        <input type="checkbox" x-model="autoRefresh" class="mr-2">
                        <span class="text-sm">Auto-refresh (30s)</span>
                    </label>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="mt-4 flex items-center space-x-4">
                <button @click="selectAll()" class="text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fas fa-check-square mr-1"></i>
                    Select All
                </button>
                
                <button @click="clearSelection()" class="text-gray-600 hover:text-gray-800 text-sm">
                    <i class="fas fa-square mr-1"></i>
                    Clear Selection
                </button>
                
                <button @click="autoApproveTrusted()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                    <i class="fas fa-magic mr-1"></i>
                    Auto-Approve Trusted
                </button>
            </div>
        </div>

        <!-- Bulk Actions -->
        <div class="bg-white rounded-lg shadow mb-6 p-4" x-show="selectedEvents.length > 0">
            <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-700">
                    <span x-text="selectedEvents.length"></span> events selected
                </span>
                <div class="flex space-x-2">
                    <button @click="bulkApprove()" 
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-check mr-2"></i>
                        Approve Selected
                    </button>
                    <button @click="showBulkRejectModal = true" 
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-times mr-2"></i>
                        Reject Selected
                    </button>
                </div>
            </div>
        </div>

        <!-- Pending Events List -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">Events Pending Approval</h2>
                <p class="text-sm text-gray-600">Review and approve or reject events from RSS feeds and web scrapers</p>
            </div>
            
            <div x-show="pendingEvents.length === 0" class="p-8 text-center">
                <i class="fas fa-check-circle text-4xl text-green-500 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">All caught up!</h3>
                <p class="text-gray-600">No events are currently pending approval.</p>
            </div>
            
            <div class="divide-y divide-gray-200">
                <template x-for="event in pendingEvents" :key="event.id">
                    <div class="p-6 hover:bg-gray-50">
                        <div class="flex items-start space-x-4">
                            <!-- Checkbox -->
                            <input type="checkbox" 
                                   :value="event.id"
                                   @change="toggleEventSelection(event.id)"
                                   :checked="selectedEvents.includes(event.id)"
                                   class="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            
                            <!-- Event Details -->
                            <div class="flex-1">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <!-- Title -->
                                        <div class="flex items-center space-x-2">
                                            <h3 x-show="!event.editing" 
                                                class="text-lg font-medium text-gray-900 flex-1" 
                                                x-text="event.title"></h3>
                                            <input x-show="event.editing" 
                                                   x-model="event.title"
                                                   class="text-lg font-medium text-gray-900 flex-1 border border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                   type="text">
                                            <button @click="toggleEdit(event)" 
                                                    class="text-sm text-blue-600 hover:text-blue-800 px-2 py-1 rounded"
                                                    :class="event.editing ? 'bg-green-50 hover:bg-green-100' : 'bg-blue-50 hover:bg-blue-100'">
                                                <i :class="event.editing ? 'fas fa-check' : 'fas fa-edit'" class="mr-1"></i>
                                                <span x-text="event.editing ? 'Save' : 'Edit'"></span>
                                            </button>
                                        </div>
                                        
                                        <!-- Event Info -->
                                        <div class="mt-2 space-y-1">
                                            <!-- Date/Time -->
                                            <div class="flex items-center text-sm text-gray-600">
                                                <i class="fas fa-calendar mr-2"></i>
                                                <div x-show="!event.editing" class="flex items-center">
                                                    <span x-text="formatDateTime(event.start_datetime)"></span>
                                                    <span x-show="event.end_datetime" x-text="' - ' + formatDateTime(event.end_datetime)"></span>
                                                </div>
                                                <div x-show="event.editing" class="flex items-center space-x-2">
                                                    <input x-model="event.start_datetime" 
                                                           type="datetime-local" 
                                                           class="border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                    <span class="text-xs text-gray-400">to</span>
                                                    <input x-model="event.end_datetime" 
                                                           type="datetime-local" 
                                                           class="border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                           placeholder="End time (optional)">
                                                </div>
                                            </div>
                                            
                                            <!-- Location -->
                                            <div x-show="event.location_name || event.location || event.editing" class="flex items-center text-sm text-gray-600">
                                                <i class="fas fa-map-marker-alt mr-2"></i>
                                                <span x-show="!event.editing" x-text="event.location_name || event.location"></span>
                                                <input x-show="event.editing" 
                                                       x-model="event.location_name"
                                                       class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full"
                                                       type="text" 
                                                       placeholder="Event location">
                                            </div>
                                            
                                            <!-- Price -->
                                            <div x-show="event.price_info || event.editing" class="flex items-center text-sm text-gray-600">
                                                <i class="fas fa-dollar-sign mr-2"></i>
                                                <span x-show="!event.editing" x-text="event.price_info"></span>
                                                <input x-show="event.editing" 
                                                       x-model="event.price_info"
                                                       class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full"
                                                       type="text" 
                                                       placeholder="Event price (optional)">
                                            </div>
                                            
                                            <!-- URL/Website -->
                                            <div x-show="event.url || event.editing" class="flex items-center text-sm text-gray-600">
                                                <i class="fas fa-link mr-2"></i>
                                                <div x-show="!event.editing" class="flex items-center">
                                                    <a :href="event.url" target="_blank" 
                                                       class="text-blue-600 hover:text-blue-800 break-all"
                                                       x-text="event.url ? (event.url.length > 50 ? event.url.substring(0, 50) + '...' : event.url) : ''"></a>
                                                    <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                                                </div>
                                                <input x-show="event.editing" 
                                                       x-model="event.url"
                                                       class="border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-full"
                                                       type="url" 
                                                       placeholder="Event website URL (optional)">
                                            </div>
                                            
                                            <!-- Event Type -->
                                            <div class="flex items-center text-sm text-gray-600">
                                                <i class="fas fa-globe mr-2"></i>
                                                <div x-show="!event.editing" class="flex items-center flex-wrap gap-1">
                                                    <template x-for="type in getEventTypes(event)" :key="type">
                                                        <span class="px-2 py-1 rounded-full text-xs font-medium" 
                                                              :class="getEventTypeBadgeClass(type)"
                                                              x-text="getEventTypeLabel(type)"></span>
                                                    </template>
                                                    <button @click="autoDetectEventType(event)" 
                                                            class="ml-2 text-xs text-blue-600 hover:text-blue-800"
                                                            title="Auto-detect event type">
                                                        <i class="fas fa-magic"></i>
                                                    </button>
                                                </div>
                                                <div x-show="event.editing" class="flex flex-col space-y-2">
                                                    <div class="text-xs text-gray-600 mb-1">Select event format(s):</div>
                                                    <div class="flex flex-wrap gap-2">
                                                        <label class="flex items-center space-x-1">
                                                            <input type="checkbox" 
                                                                   :checked="isEventTypeSelected(event, 'online')"
                                                                   @change="toggleEventType(event, 'online')"
                                                                   class="text-blue-600 focus:ring-blue-500 rounded">
                                                            <span class="text-xs">üåê Online</span>
                                                        </label>
                                                        <label class="flex items-center space-x-1">
                                                            <input type="checkbox" 
                                                                   :checked="isEventTypeSelected(event, 'in-person')"
                                                                   @change="toggleEventType(event, 'in-person')"
                                                                   class="text-green-600 focus:ring-green-500 rounded">
                                                            <span class="text-xs">üìç In-Person</span>
                                                        </label>
                                                        <label class="flex items-center space-x-1">
                                                            <input type="checkbox" 
                                                                   :checked="isEventTypeSelected(event, 'unknown')"
                                                                   @change="toggleEventType(event, 'unknown')"
                                                                   class="text-gray-600 focus:ring-gray-500 rounded">
                                                            <span class="text-xs">‚ùì Unknown</span>
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Description -->
                                            <div x-show="event.description || event.editing" class="mt-2">
                                                <div x-show="!event.editing" class="text-sm text-gray-600">
                                                    <span x-text="event.description"></span>
                                                </div>
                                                <div x-show="event.editing">
                                                    <label class="block text-xs font-medium text-gray-700 mb-1">Description:</label>
                                                    <textarea x-model="event.description"
                                                              class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                              rows="3"
                                                              placeholder="Event description"></textarea>
                                                </div>
                                            </div>
                                            
                                            <!-- Discovery Info -->
                                            <div class="flex items-center text-sm text-gray-600">
                                                <i class="fas fa-search mr-2"></i>
                                                <span class="text-gray-500">Discovered:</span>
                                                <span class="ml-1 font-medium" x-text="formatDateTime(event.created_at)"></span>
                                                <span class="ml-2 text-xs px-2 py-1 rounded-full font-medium"
                                                      :class="getFreshnessBadgeClass(event.created_at)"
                                                      x-text="getTimeAgo(event.created_at)"></span>
                                            </div>
                                            
                                            <div class="flex items-center text-sm text-gray-600">
                                                <i class="fas fa-tag mr-2"></i>
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                                      :class="getSourceBadgeClass(event.source)">
                                                    <i :class="getSourceIcon(event.source)" class="mr-1"></i>
                                                    <span x-text="getSourceLabel(event)"></span>
                                                </span>
                                            </div>
                                        </div>
                                        
                                        <!-- Description -->
                                        <div x-show="event.description" class="mt-3">
                                            <p class="text-sm text-gray-700" x-text="event.description.substring(0, 200) + (event.description.length > 200 ? '...' : '')"></p>
                                        </div>
                                        
                                    </div>
                                    
                                    <!-- Actions -->
                                    <div class="flex items-center space-x-2 ml-4">
                                        <button @click="approveEvent(event.id)" 
                                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                            <i class="fas fa-check mr-1"></i>
                                            Approve
                                        </button>
                                        <button @click="showRejectModal(event)" 
                                                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                            <i class="fas fa-times mr-1"></i>
                                            Reject
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </main>

    <!-- Reject Modal -->
    <div x-show="showRejectModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
         @click="showRejectModal = false">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
             @click.stop>
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Reject Event</h3>
                <p class="text-sm text-gray-600 mb-4">Please provide a reason for rejecting this event:</p>
                
                <textarea x-model="rejectReason" 
                          placeholder="Enter rejection reason..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                          rows="3"></textarea>
                
                <div class="flex justify-end space-x-2 mt-4">
                    <button @click="showRejectModal = false" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                    <button @click="rejectEvent()" 
                            class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        Reject Event
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Reject Modal -->
    <div x-show="showBulkRejectModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
         @click="showBulkRejectModal = false">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
             @click.stop>
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Reject Selected Events</h3>
                <p class="text-sm text-gray-600 mb-4">Please provide a reason for rejecting <span x-text="selectedEvents.length"></span> events:</p>
                
                <textarea x-model="bulkRejectReason" 
                          placeholder="Enter rejection reason..."
                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                          rows="3"></textarea>
                
                <div class="flex justify-end space-x-2 mt-4">
                    <button @click="showBulkRejectModal = false" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        Cancel
                    </button>
                    <button @click="bulkReject()" 
                            class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                        Reject Events
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function approvalApp() {
            return {
                pendingEvents: [],
                selectedEvents: [],
                showRejectModal: false,
                showBulkRejectModal: false,
                rejectReason: '',
                bulkRejectReason: '',
                currentRejectEventId: null,
                approvedToday: 0,
                rejectedToday: 0,
                
                // Enhanced filtering and sorting
                sortBy: 'event_date',
                sourceFilter: 'all',
                dateFrom: '',
                dateTo: '',
                autoRefresh: false,
                refreshInterval: null,
                
                async init() {
                    await this.loadEvents();
                    this.setupAutoRefresh();
                },
                
                setupAutoRefresh() {
                    this.$watch('autoRefresh', (enabled) => {
                        if (enabled) {
                            this.refreshInterval = setInterval(() => {
                                this.loadEvents();
                            }, 30000); // 30 seconds
                        } else if (this.refreshInterval) {
                            clearInterval(this.refreshInterval);
                        }
                    });
                },
                
                async loadEvents() {
                    try {
                        const params = new URLSearchParams({
                            sort: this.sortBy,
                            source: this.sourceFilter,
                            date_from: this.dateFrom,
                            date_to: this.dateTo
                        });
                        
                        const response = await fetch(`/api/admin/events/pending-enhanced?${params}`);
                        this.pendingEvents = await response.json();
                        
                        // Initialize editing state for each event
                        this.pendingEvents.forEach(event => {
                            if (event.editing === undefined) {
                                event.editing = false;
                            }
                        });
                    } catch (error) {
                        console.error('Error loading pending events:', error);
                    }
                },
                
                toggleEdit(event) {
                    if (event.editing) {
                        // Save the event
                        this.saveEvent(event);
                    } else {
                        // Start editing
                        event.editing = true;
                        
                        // Convert datetime for HTML5 input (remove timezone for local input)
                        if (event.start_datetime) {
                            const dt = new Date(event.start_datetime);
                            event.start_datetime = dt.toISOString().slice(0, 16);
                        }
                        if (event.end_datetime) {
                            const dt = new Date(event.end_datetime);
                            event.end_datetime = dt.toISOString().slice(0, 16);
                        }
                    }
                },
                
                async saveEvent(event) {
                    try {
                        // Convert datetime back to ISO format
                        const eventData = {
                            title: event.title,
                            description: event.description,
                            start_datetime: event.start_datetime ? new Date(event.start_datetime).toISOString() : null,
                            end_datetime: event.end_datetime ? new Date(event.end_datetime).toISOString() : null,
                            location_name: event.location_name,
                            price_info: event.price_info,
                            event_type: event.event_type
                        };
                        
                        const response = await fetch(`/api/admin/events/${event.id}/update`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(eventData)
                        });
                        
                        if (response.ok) {
                            event.editing = false;
                            this.showNotification('Event updated successfully!', 'success');
                            
                            // Refresh the event data
                            await this.loadEvents();
                        } else {
                            const error = await response.json();
                            this.showNotification(`Error updating event: ${error.message}`, 'error');
                        }
                    } catch (error) {
                        console.error('Error saving event:', error);
                        this.showNotification('Network error updating event', 'error');
                    }
                },
                
                async loadPendingEvents() {
                    // Maintain backward compatibility
                    await this.loadEvents();
                },
                
                async refreshPendingEvents() {
                    await this.loadPendingEvents();
                },
                
                toggleEventSelection(eventId) {
                    const index = this.selectedEvents.indexOf(eventId);
                    if (index > -1) {
                        this.selectedEvents.splice(index, 1);
                    } else {
                        this.selectedEvents.push(eventId);
                    }
                },
                
                async approveEvent(eventId) {
                    try {
                        const response = await fetch(`/api/admin/events/${eventId}/approve`, {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            await this.loadPendingEvents();
                            this.approvedToday++;
                            alert('Event approved successfully');
                        } else {
                            alert('Error approving event');
                        }
                    } catch (error) {
                        console.error('Error approving event:', error);
                        alert('Error approving event');
                    }
                },
                
                showRejectModal(event) {
                    this.currentRejectEventId = event.id;
                    this.rejectReason = '';
                    this.showRejectModal = true;
                },
                
                async rejectEvent() {
                    if (!this.rejectReason.trim()) {
                        alert('Please provide a rejection reason');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/api/admin/events/${this.currentRejectEventId}/reject`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reason: this.rejectReason })
                        });
                        
                        if (response.ok) {
                            await this.loadPendingEvents();
                            this.rejectedToday++;
                            this.showRejectModal = false;
                            alert('Event rejected successfully');
                        } else {
                            alert('Error rejecting event');
                        }
                    } catch (error) {
                        console.error('Error rejecting event:', error);
                        alert('Error rejecting event');
                    }
                },
                
                async bulkApprove() {
                    if (this.selectedEvents.length === 0) {
                        alert('Please select events to approve');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/admin/events/bulk-approve', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ event_ids: this.selectedEvents })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            await this.loadPendingEvents();
                            this.approvedToday += result.approved_count;
                            this.selectedEvents = [];
                            alert(`Successfully approved ${result.approved_count} events`);
                        } else {
                            alert('Error approving events');
                        }
                    } catch (error) {
                        console.error('Error bulk approving events:', error);
                        alert('Error approving events');
                    }
                },
                
                async bulkReject() {
                    if (this.selectedEvents.length === 0) {
                        alert('Please select events to reject');
                        return;
                    }
                    
                    if (!this.bulkRejectReason.trim()) {
                        alert('Please provide a rejection reason');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/admin/events/bulk-reject', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                event_ids: this.selectedEvents,
                                reason: this.bulkRejectReason
                            })
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            await this.loadPendingEvents();
                            this.rejectedToday += result.rejected_count;
                            this.selectedEvents = [];
                            this.showBulkRejectModal = false;
                            alert(`Successfully rejected ${result.rejected_count} events`);
                        } else {
                            alert('Error rejecting events');
                        }
                    } catch (error) {
                        console.error('Error bulk rejecting events:', error);
                        alert('Error rejecting events');
                    }
                },
                
                formatDateTime(datetime) {
                    if (!datetime) return '';
                    const date = new Date(datetime);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                },
                
                getTimeAgo(datetime) {
                    if (!datetime) return '';
                    const now = new Date();
                    const eventTime = new Date(datetime);
                    const diffMs = now - eventTime;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    if (diffMins < 1) return 'just now';
                    if (diffMins < 60) return `${diffMins}m ago`;
                    if (diffHours < 24) return `${diffHours}h ago`;
                    if (diffDays < 7) return `${diffDays}d ago`;
                    return eventTime.toLocaleDateString();
                },
                
                getFreshnessBadgeClass(datetime) {
                    if (!datetime) return 'bg-gray-100 text-gray-600';
                    const now = new Date();
                    const eventTime = new Date(datetime);
                    const diffMs = now - eventTime;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    // Very fresh (less than 1 hour) - green
                    if (diffMins < 60) return 'bg-green-100 text-green-700';
                    // Fresh (less than 24 hours) - blue
                    if (diffHours < 24) return 'bg-blue-100 text-blue-700';
                    // Recent (less than 7 days) - yellow
                    if (diffDays < 7) return 'bg-yellow-100 text-yellow-700';
                    // Older - gray
                    return 'bg-gray-100 text-gray-600';
                },
                
                getFreshEventsCount() {
                    const now = new Date();
                    return this.pendingEvents.filter(event => {
                        if (!event.created_at) return false;
                        const eventTime = new Date(event.created_at);
                        const diffMs = now - eventTime;
                        const diffMins = Math.floor(diffMs / 60000);
                        return diffMins < 60; // Less than 1 hour
                    }).length;
                },
                
                getSourceBadgeClass(source) {
                    switch (source) {
                        case 'rss': return 'bg-blue-100 text-blue-800';
                        case 'scraper': return 'bg-purple-100 text-purple-800';
                        case 'manual': return 'bg-gray-100 text-gray-800';
                        default: return 'bg-yellow-100 text-yellow-800';
                    }
                },
                
                getSourceIcon(source) {
                    switch (source) {
                        case 'rss': return 'fas fa-rss';
                        case 'scraper': return 'fas fa-spider';
                        case 'manual': return 'fas fa-hand-paper';
                        default: return 'fas fa-question';
                    }
                },
                
                getSourceLabel(event) {
                    if (event.source === 'rss') {
                        return 'RSS Feed';
                    } else if (event.source === 'scraper') {
                        return 'Web Scraper';
                    } else if (event.source === 'manual') {
                        return 'Manual';
                    } else {
                        return 'Unknown';
                    }
                },
                
                // Enhanced methods for new functionality
                selectAll() {
                    this.selectedEvents = this.pendingEvents.map(event => event.id);
                },
                
                clearSelection() {
                    this.selectedEvents = [];
                },
                
                async autoApproveTrusted() {
                    try {
                        const response = await fetch('/api/admin/events/auto-approve-trusted', {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            await this.loadEvents();
                            this.approvedToday += result.approved_count;
                            alert(result.message);
                        } else {
                            alert('Error auto-approving trusted events');
                        }
                    } catch (error) {
                        console.error('Error auto-approving trusted events:', error);
                        alert('Error auto-approving trusted events');
                    }
                },
                
                getConfidenceColor(confidence) {
                    if (confidence >= 90) return 'bg-green-500';
                    if (confidence >= 80) return 'bg-yellow-500';
                    return 'bg-red-500';
                },
                
                // Event Type Helper Functions
                getEventTypeLabel(eventType) {
                    const labels = {
                        'online': 'üåê Online',
                        'in-person': 'üìç In-Person', 
                        'hybrid': 'üîÑ Hybrid',
                        'unknown': '‚ùì Unknown'
                    };
                    return labels[eventType] || '‚ùì Unknown';
                },
                
                getEventTypeBadgeClass(eventType) {
                    const classes = {
                        'online': 'bg-blue-100 text-blue-800',
                        'in-person': 'bg-green-100 text-green-800',
                        'hybrid': 'bg-purple-100 text-purple-800',
                        'unknown': 'bg-gray-100 text-gray-800'
                    };
                    return classes[eventType] || 'bg-gray-100 text-gray-800';
                },
                
                // Event type management for multiple selections
                getEventTypes(event) {
                    if (!event.event_type) return ['unknown'];
                    
                    // Handle both old single-value and new array formats
                    if (Array.isArray(event.event_type)) {
                        return event.event_type.length > 0 ? event.event_type : ['unknown'];
                    }
                    
                    // Handle comma-separated string format
                    if (typeof event.event_type === 'string' && event.event_type.includes(',')) {
                        return event.event_type.split(',').map(type => type.trim());
                    }
                    
                    // Handle single value
                    return [event.event_type];
                },
                
                isEventTypeSelected(event, type) {
                    const types = this.getEventTypes(event);
                    return types.includes(type);
                },
                
                toggleEventType(event, type) {
                    let types = this.getEventTypes(event);
                    
                    if (types.includes(type)) {
                        // Remove the type
                        types = types.filter(t => t !== type);
                    } else {
                        // Add the type and remove 'unknown' if it exists
                        types = types.filter(t => t !== 'unknown');
                        types.push(type);
                    }
                    
                    // If no types selected, default to unknown
                    if (types.length === 0) {
                        types = ['unknown'];
                    }
                    
                    // Store as comma-separated string for backend compatibility
                    event.event_type = types.join(',');
                },

                autoDetectEventType(event) {
                    // Enhanced auto-detection for multiple types
                    const title = (event.title || '').toLowerCase();
                    const description = (event.description || '').toLowerCase();
                    const location = (event.location_name || '').toLowerCase();
                    const url = (event.url || '').toLowerCase();
                    
                    const allText = `${title} ${description} ${location} ${url}`;
                    let detectedTypes = [];
                    
                    // Check for online indicators
                    if (allText.includes('zoom') || allText.includes('virtual') || 
                        allText.includes('online') || allText.includes('webinar') ||
                        allText.includes('livestream') || allText.includes('remote')) {
                        detectedTypes.push('online');
                    }
                    
                    // Check for in-person indicators
                    if ((location && !location.includes('virtual') && !location.includes('online')) ||
                        allText.includes('venue') || allText.includes('address') ||
                        allText.includes('hall') || allText.includes('center')) {
                        detectedTypes.push('in-person');
                    }
                    
                    // If no types detected, mark as unknown
                    if (detectedTypes.length === 0) {
                        detectedTypes = ['unknown'];
                    }
                    
                    event.event_type = detectedTypes.join(',');
                    
                    const typeLabels = detectedTypes.map(type => this.getEventTypeLabel(type)).join(', ');
                    this.showNotification(`Event type auto-detected as: ${typeLabels}`, 'success');
                }
            }
        }
    </script>
</body>
</html>
