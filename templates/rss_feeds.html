{% extends "base.html" %}

{% block title %}RSS Feeds Management{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8" x-data="rssFeedsManager()">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">RSS Feeds Management</h1>
            <p class="text-gray-600 mt-2">Manage RSS feeds for automatic event import</p>
        </div>
        <div class="flex space-x-3">
            <button @click="showAddFeedModal = true" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-plus mr-2"></i>Add Feed
            </button>
            <button @click="refreshAllFeeds()" 
                    :disabled="isRefreshing"
                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50">
                <i class="fas fa-sync-alt mr-2" :class="{'animate-spin': isRefreshing}"></i>
                <span x-text="isRefreshing ? 'Refreshing...' : 'Refresh All'"></span>
            </button>
        </div>
    </div>

    <!-- Scheduler Status -->
    <div class="bg-white p-4 rounded-lg shadow mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="p-2 bg-blue-100 rounded-lg mr-3">
                    <i class="fas fa-clock text-blue-600"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">RSS Scheduler</h3>
                    <p class="text-sm text-gray-600" x-text="schedulerStatus.running ? 'Running automatically' : 'Not running'"></p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm text-gray-500" x-show="schedulerStatus.next_run">
                    Next check: <span x-text="formatDateTime(schedulerStatus.next_run)"></span>
                </div>
                <div class="text-xs text-gray-400" x-show="schedulerStatus.jobs_count">
                    <span x-text="schedulerStatus.jobs_count"></span> scheduled jobs
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Analytics Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Feeds -->
        <div class="bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Feeds</p>
                    <p class="text-3xl font-bold text-gray-900" x-text="feeds.length"></p>
                    <p class="text-xs text-gray-500 mt-1">
                        <span x-text="feeds.filter(f => f.is_active).length"></span> active
                    </p>
                </div>
                <div class="p-3 bg-blue-100 rounded-lg">
                    <i class="fas fa-rss text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Events Today -->
        <div class="bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Events Today</p>
                    <p class="text-3xl font-bold text-green-600" x-text="analytics.eventsToday || 0"></p>
                    <p class="text-xs text-gray-500 mt-1">
                        <span x-text="analytics.eventsThisWeek || 0"></span> this week
                    </p>
                </div>
                <div class="p-3 bg-green-100 rounded-lg">
                    <i class="fas fa-calendar-plus text-green-600 text-xl"></i>
                </div>
            </div>
        </div>
        
        <!-- System Health -->
        <div class="bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">System Health</p>
                    <p class="text-3xl font-bold" 
                       :class="getHealthScoreClass(analytics.healthScore)"
                       x-text="analytics.healthScore + '%'"></p>
                    <p class="text-xs text-gray-500 mt-1">
                        <span x-text="feeds.filter(f => f.consecutive_failures > 0).length"></span> issues
                    </p>
                </div>
                <div class="p-3 rounded-lg" :class="getHealthScoreBgClass(analytics.healthScore)">
                    <i class="fas fa-heartbeat text-xl" :class="getHealthScoreIconClass(analytics.healthScore)"></i>
                </div>
            </div>
        </div>
        
        <!-- Processing Speed -->
        <div class="bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Avg Response</p>
                    <p class="text-3xl font-bold text-blue-600" x-text="analytics.avgResponseTime + 'ms'"></p>
                    <p class="text-xs text-gray-500 mt-1">
                        <span x-text="analytics.totalEvents"></span> total events
                    </p>
                </div>
                <div class="p-3 bg-blue-100 rounded-lg">
                    <i class="fas fa-tachometer-alt text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Feed Performance Overview -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Top Performing Feeds -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">üèÜ Top Performers</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <template x-for="feed in getTopPerformingFeeds()" :key="feed.id">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-trophy text-green-600 text-sm"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900" x-text="feed.name"></p>
                                    <p class="text-xs text-gray-500" x-text="feed.total_events + ' events'"></p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-bold text-green-600" x-text="getFeedHealthScore(feed) + '%'"></div>
                                <div class="text-xs text-gray-500">health</div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">üìà Recent Activity</h3>
            </div>
            <div class="p-6">
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-sm text-gray-600">Events processed today</span>
                        </div>
                        <span class="text-sm font-medium text-gray-900" x-text="analytics.eventsToday || 0"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <span class="text-sm text-gray-600">Feeds checked</span>
                        </div>
                        <span class="text-sm font-medium text-gray-900" x-text="analytics.feedsChecked || 0"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
                            <span class="text-sm text-gray-600">Errors resolved</span>
                        </div>
                        <span class="text-sm font-medium text-gray-900" x-text="analytics.errorsResolved || 0"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                            <span class="text-sm text-gray-600">Avg processing time</span>
                        </div>
                        <span class="text-sm font-medium text-gray-900" x-text="analytics.avgProcessingTime + 'ms'"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">‚ö° System Status</h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Scheduler</span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                              :class="schedulerStatus.running ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                            <i class="fas mr-1" :class="schedulerStatus.running ? 'fa-check-circle' : 'fa-times-circle'"></i>
                            <span x-text="schedulerStatus.running ? 'Running' : 'Stopped'"></span>
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Database</span>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>
                            <span>Healthy</span>
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Last Update</span>
                        <span class="text-sm text-gray-900" x-text="formatTimeAgo(analytics.lastUpdate)"></span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Next Check</span>
                        <span class="text-sm text-gray-900" x-text="formatTimeAgo(schedulerStatus.next_run)"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feeds Grid -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">RSS Feeds</h2>
        </div>
        
        <div class="p-6">
            <!-- Bulk Operations Toolbar -->
            <div x-show="selectedFeeds.length > 0" 
                 class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-blue-900">
                            <span x-text="selectedFeeds.length"></span> feeds selected
                        </span>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button @click="bulkEnable()" 
                                class="inline-flex items-center px-3 py-1.5 border border-blue-300 text-sm font-medium rounded text-blue-700 bg-white hover:bg-blue-50">
                            <i class="fas fa-play mr-1"></i> Enable
                        </button>
                        <button @click="bulkDisable()" 
                                class="inline-flex items-center px-3 py-1.5 border border-blue-300 text-sm font-medium rounded text-blue-700 bg-white hover:bg-blue-50">
                            <i class="fas fa-pause mr-1"></i> Disable
                        </button>
                        <button @click="bulkRefresh()" 
                                class="inline-flex items-center px-3 py-1.5 border border-blue-300 text-sm font-medium rounded text-blue-700 bg-white hover:bg-blue-50">
                            <i class="fas fa-sync-alt mr-1"></i> Refresh
                        </button>
                        <button @click="bulkDelete()" 
                                class="inline-flex items-center px-3 py-1.5 border border-red-300 text-sm font-medium rounded text-red-700 bg-white hover:bg-red-50">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <template x-for="feed in feeds" :key="feed.id">
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                         :class="selectedFeeds.includes(feed.id) ? 'ring-2 ring-blue-500' : ''">
                        <!-- Compact Feed Header -->
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-2 flex-1 min-w-0">
                                <input type="checkbox" 
                                       :value="feed.id"
                                       @change="toggleFeedSelection(feed.id)"
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded flex-shrink-0">
                                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-rss text-blue-600 text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="text-sm font-medium text-gray-900 truncate" x-text="feed.name"></h3>
                                    <p class="text-xs text-gray-500 truncate" x-text="feed.url"></p>
                                </div>
                            </div>
                            
                            <!-- Status Badge -->
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium flex-shrink-0"
                                  :class="getStatusClass(feed)">
                                <i class="fas mr-1" :class="getStatusIcon(feed)"></i>
                                <span x-text="getStatusText(feed)"></span>
                            </span>
                        </div>
                        
                        <!-- Compact Stats Row -->
                        <div class="grid grid-cols-4 gap-2 mb-3">
                            <div class="text-center p-2 bg-gray-50 rounded">
                                <div class="text-lg font-bold text-green-600" x-text="feed.total_events || 0"></div>
                                <div class="text-xs text-gray-500">Events</div>
                            </div>
                            <div class="text-center p-2 bg-gray-50 rounded">
                                <div class="text-lg font-bold text-blue-600" x-text="feed.update_interval"></div>
                                <div class="text-xs text-gray-500">Min</div>
                            </div>
                            <div class="text-center p-2 bg-gray-50 rounded">
                                <div class="text-lg font-bold" 
                                     :class="feed.consecutive_failures > 0 ? 'text-red-600' : 'text-gray-600'" 
                                     x-text="feed.consecutive_failures || 0"></div>
                                <div class="text-xs text-gray-500">Errors</div>
                            </div>
                            <div class="text-center p-2 bg-gray-50 rounded">
                                <div class="text-lg font-bold text-purple-600" x-text="getFeedHealthScore(feed) + '%'"></div>
                                <div class="text-xs text-gray-500">Health</div>
                            </div>
                        </div>
                        
                        <!-- Recent Events Preview -->
                        <div class="mb-3" x-show="feed.recent_events && feed.recent_events.length > 0">
                            <div class="text-xs font-medium text-gray-600 mb-2">Recent Events:</div>
                            <div class="space-y-1 max-h-20 overflow-y-auto">
                                <template x-for="event in (feed.recent_events || []).slice(0, 3)" :key="event.id">
                                    <div class="flex items-center space-x-2 text-xs">
                                        <div class="w-1.5 h-1.5 bg-green-500 rounded-full flex-shrink-0"></div>
                                        <span class="text-gray-700 truncate flex-1" x-text="event.title"></span>
                                        <span class="text-gray-500 flex-shrink-0" x-text="formatEventDate(event.start_datetime)"></span>
                                    </div>
                                </template>
                                <div x-show="feed.recent_events && feed.recent_events.length > 3" class="text-xs text-gray-500 text-center pt-1">
                                    +<span x-text="(feed.recent_events || []).length - 3"></span> more events
                                </div>
                            </div>
                        </div>
                        
                        <!-- Last Check & Actions Row -->
                        <div class="flex items-center justify-between">
                            <div class="text-xs text-gray-500">
                                <span class="font-medium">Last:</span> <span x-text="getTimeAgo(feed.last_checked)"></span>
                            </div>
                            
                            <!-- Compact Action Buttons -->
                            <div class="flex space-x-1">
                                <button @click="refreshFeed(feed.id)" 
                                        :disabled="isRefreshing"
                                        class="p-1.5 text-blue-600 hover:bg-blue-50 rounded disabled:opacity-50"
                                        title="Refresh">
                                    <i class="fas fa-sync-alt text-xs" :class="{'animate-spin': isRefreshing}"></i>
                                </button>
                                <button @click="editFeed(feed)" 
                                        class="p-1.5 text-indigo-600 hover:bg-indigo-50 rounded"
                                        title="Edit">
                                    <i class="fas fa-edit text-xs"></i>
                                </button>
                                <button @click="testFeed(feed.url)" 
                                        class="p-1.5 text-green-600 hover:bg-green-50 rounded"
                                        title="Test">
                                    <i class="fas fa-vial text-xs"></i>
                                </button>
                                <button @click="viewFeedEvents(feed.id)" 
                                        class="p-1.5 text-purple-600 hover:bg-purple-50 rounded"
                                        title="View Events">
                                    <i class="fas fa-list text-xs"></i>
                                </button>
                                <button @click="viewLogs(feed.id)" 
                                        class="p-1.5 text-gray-600 hover:bg-gray-50 rounded"
                                        title="Logs">
                                    <i class="fas fa-history text-xs"></i>
                                </button>
                                <button @click="deleteFeed(feed.id)" 
                                        class="p-1.5 text-red-600 hover:bg-red-50 rounded"
                                        title="Delete">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
            
            <!-- Empty State -->
            <div x-show="feeds.length === 0" class="text-center py-12">
                <div class="mx-auto h-12 w-12 text-gray-400">
                    <i class="fas fa-rss text-4xl"></i>
                </div>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No RSS feeds</h3>
                <p class="mt-1 text-sm text-gray-500">Get started by adding your first RSS feed.</p>
                <div class="mt-6">
                    <button @click="showAddFeedModal = true" 
                            class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        <i class="fas fa-plus mr-2"></i>
                        Add RSS Feed
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Feed Modal -->
    <div x-show="showAddFeedModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto" 
         style="display: none;">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showAddFeedModal = false"></div>
            
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form @submit.prevent="addFeed()">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Add RSS Feed</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Feed Name</label>
                                <input type="text" x-model="newFeed.name" required
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">RSS URL</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="url" x-model="newFeed.url" required
                                           class="flex-1 border-gray-300 rounded-l-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <button type="button" @click="testFeedUrl(newFeed.url)"
                                            :disabled="!newFeed.url || isTestingUrl"
                                            class="inline-flex items-center px-3 py-2 border border-l-0 border-gray-300 rounded-r-md bg-gray-50 text-gray-500 text-sm hover:bg-gray-100 disabled:opacity-50">
                                        <i class="fas fa-vial mr-1" :class="{'animate-spin': isTestingUrl}"></i>
                                        <span x-text="isTestingUrl ? 'Testing...' : 'Test'"></span>
                                    </button>
                                </div>
                                <div x-show="testResult" class="mt-2 p-3 rounded-md" 
                                     :class="testResult && testResult.success ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'">
                                    <div class="text-sm" x-text="testResult ? testResult.message : ''"></div>
                                    <div x-show="testResult && testResult.success && testResult.events" class="text-xs mt-1">
                                        Found <span x-text="testResult ? testResult.events : 0"></span> events
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea x-model="newFeed.description" rows="3"
                                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Category</label>
                                    <select x-model="newFeed.category"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                        <option value="events">Events</option>
                                        <option value="news">News</option>
                                        <option value="culture">Culture</option>
                                        <option value="sports">Sports</option>
                                        <option value="community">Community</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Update Interval (minutes)</label>
                                    <select x-model="newFeed.update_interval"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                        <option value="15">15 minutes</option>
                                        <option value="30">30 minutes</option>
                                        <option value="60">1 hour</option>
                                        <option value="120">2 hours</option>
                                        <option value="240">4 hours</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" 
                                :disabled="isAdding"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50">
                            <span x-text="isAdding ? 'Adding...' : 'Add Feed'"></span>
                        </button>
                        <button type="button" @click="showAddFeedModal = false"
                                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Feed Modal -->
    <div x-show="showEditFeedModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto" 
         style="display: none;">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showEditFeedModal = false"></div>
            
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form @submit.prevent="updateFeed()">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Edit RSS Feed</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Feed Name</label>
                                <input type="text" x-model="editingFeed.name" required
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">RSS URL</label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="url" x-model="editingFeed.url" required
                                           class="flex-1 border-gray-300 rounded-l-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <button type="button" @click="testFeedUrl(editingFeed.url)"
                                            :disabled="!editingFeed.url || isTestingUrl"
                                            class="inline-flex items-center px-3 py-2 border border-l-0 border-gray-300 rounded-r-md bg-gray-50 text-gray-500 text-sm hover:bg-gray-100 disabled:opacity-50">
                                        <i class="fas fa-vial mr-1" :class="{'animate-spin': isTestingUrl}"></i>
                                        <span x-text="isTestingUrl ? 'Testing...' : 'Test'"></span>
                                    </button>
                                </div>
                                <div x-show="testResult" class="mt-2 p-3 rounded-md" 
                                     :class="testResult && testResult.success ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'">
                                    <div class="text-sm" x-text="testResult ? testResult.message : ''"></div>
                                    <div x-show="testResult && testResult.success && testResult.events" class="text-xs mt-1">
                                        Found <span x-text="testResult ? testResult.events : 0"></span> events
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea x-model="editingFeed.description" rows="3"
                                          class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Category</label>
                                    <select x-model="editingFeed.category"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                        <option value="events">Events</option>
                                        <option value="news">News</option>
                                        <option value="culture">Culture</option>
                                        <option value="sports">Sports</option>
                                        <option value="community">Community</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Update Interval (minutes)</label>
                                    <select x-model="editingFeed.update_interval"
                                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                        <option value="15">15 minutes</option>
                                        <option value="30">30 minutes</option>
                                        <option value="60">1 hour</option>
                                        <option value="120">2 hours</option>
                                        <option value="240">4 hours</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="checkbox" x-model="editingFeed.enabled" 
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label class="ml-2 block text-sm text-gray-900">
                                    Enable this feed
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit" 
                                :disabled="isUpdating"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50">
                            <span x-text="isUpdating ? 'Updating...' : 'Update Feed'"></span>
                        </button>
                        <button type="button" @click="showEditFeedModal = false"
                                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Activity Logs Modal -->
    <!-- Feed Events Modal -->
    <div x-show="showFeedEventsModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto" 
         style="display: none;">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showFeedEventsModal = false"></div>
            
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                                <i class="fas fa-list text-blue-600 mr-2"></i>
                                Events from <span x-text="selectedFeedName"></span>
                            </h3>
                            
                            <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                                <div class="space-y-2">
                                    <template x-for="event in feedEvents" :key="event.id">
                                        <div class="flex items-center space-x-3 p-3 bg-white rounded border hover:bg-gray-50">
                                            <div class="flex-shrink-0">
                                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <p class="text-sm font-medium text-gray-900 truncate" x-text="event.title"></p>
                                                <p class="text-xs text-gray-600 truncate" x-text="event.description || 'No description'"></p>
                                                <div class="flex items-center space-x-4 mt-1">
                                                    <span class="text-xs text-gray-500">
                                                        <i class="fas fa-calendar mr-1"></i>
                                                        <span x-text="formatEventDate(event.start_datetime)"></span>
                                                    </span>
                                                    <span x-show="event.location_name" class="text-xs text-gray-500">
                                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                                        <span x-text="event.location_name"></span>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="flex-shrink-0">
                                                <a :href="event.url" target="_blank" 
                                                   class="text-xs text-blue-600 hover:text-blue-800">
                                                    <i class="fas fa-external-link-alt"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <div x-show="feedEvents.length === 0" class="text-center py-8 text-gray-500">
                                        <i class="fas fa-calendar-times text-4xl mb-4"></i>
                                        <p>No events found for this feed</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="showFeedEventsModal = false" 
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div x-show="showLogsModal" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto" 
         style="display: none;">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showLogsModal = false"></div>
            
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Activity Logs</h3>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Events</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Response Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Message</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="log in logs" :key="log.id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDateTime(log.check_time)"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                                  :class="getLogStatusClass(log.status)">
                                                <span x-text="log.status"></span>
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <span x-show="log.events_added > 0" class="text-green-600">+<span x-text="log.events_added"></span></span>
                                            <span x-show="log.events_updated > 0" class="text-blue-600">~<span x-text="log.events_updated"></span></span>
                                            <span x-show="log.events_skipped > 0" class="text-gray-600">-<span x-text="log.events_skipped"></span></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="log.response_time_ms + 'ms'"></td>
                                        <td class="px-6 py-4 text-sm text-gray-500" x-text="log.error_message || 'Success'"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button @click="showLogsModal = false"
                            class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function rssFeedsManager() {
    return {
        feeds: [],
        logs: [],
        selectedFeeds: [],
        analytics: {
            eventsToday: 0,
            eventsThisWeek: 0,
            healthScore: 0,
            avgResponseTime: 0,
            totalEvents: 0,
            feedsChecked: 0,
            errorsResolved: 0,
            avgProcessingTime: 0,
            lastUpdate: null
        },
        schedulerStatus: { running: false, next_run: null, jobs_count: 0 },
        showAddFeedModal: false,
        showEditFeedModal: false,
        showLogsModal: false,
        showFeedEventsModal: false,
        feedEvents: [],
        selectedFeedName: '',
        isRefreshing: false,
        isAdding: false,
        isUpdating: false,
        isTestingUrl: false,
        testResult: null,
        newFeed: {
            name: '',
            url: '',
            description: '',
            category: 'events',
            update_interval: 30
        },
        editingFeed: {
            id: null,
            name: '',
            url: '',
            description: '',
            category: 'events',
            update_interval: 30,
            enabled: true
        },
        
        async init() {
            await this.loadFeeds();
            await this.loadSchedulerStatus();
            await this.loadAnalytics();
        },
        
        async loadFeeds() {
            try {
                const response = await fetch('/api/rss-feeds');
                const data = await response.json();
                this.feeds = data || [];
                
                // Load recent events for each feed
                for (let feed of this.feeds) {
                    try {
                        const eventsResponse = await fetch(`/api/rss-feeds/${feed.id}/events?limit=5`);
                        const eventsData = await eventsResponse.json();
                        if (eventsData.success) {
                            feed.recent_events = eventsData.events || [];
                        }
                    } catch (error) {
                        console.error(`Error loading events for feed ${feed.id}:`, error);
                        feed.recent_events = [];
                    }
                }
            } catch (error) {
                console.error('Error loading feeds:', error);
                this.feeds = [];
            }
        },
        
        async loadSchedulerStatus() {
            try {
                const response = await fetch('/api/rss-feeds/scheduler-status');
                const data = await response.json();
                this.schedulerStatus = data;
            } catch (error) {
                console.error('Error loading scheduler status:', error);
            }
        },
        
        async loadAnalytics() {
            try {
                const response = await fetch('/api/rss-feeds/analytics');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                this.analytics = {
                    eventsToday: data.eventsToday || 0,
                    eventsThisWeek: data.eventsThisWeek || 0,
                    healthScore: data.healthScore || 0,
                    avgResponseTime: data.avgResponseTime || 0,
                    totalEvents: data.totalEvents || 0,
                    feedsChecked: data.feedsChecked || 0,
                    errorsResolved: data.errorsResolved || 0,
                    avgProcessingTime: data.avgProcessingTime || 0,
                    lastUpdate: data.lastUpdate
                };
            } catch (error) {
                console.error('Error loading analytics:', error);
                // Calculate basic analytics from feeds data
                this.calculateBasicAnalytics();
            }
        },
        
        calculateBasicAnalytics() {
            const totalEvents = this.feeds.reduce((sum, f) => sum + (f.total_events || 0), 0);
            const activeFeeds = this.feeds.filter(f => f.is_active).length;
            const errorFeeds = this.feeds.filter(f => f.consecutive_failures > 0).length;
            
            this.analytics = {
                eventsToday: Math.floor(totalEvents * 0.1), // Estimate
                eventsThisWeek: Math.floor(totalEvents * 0.3), // Estimate
                healthScore: activeFeeds > 0 ? Math.max(0, 100 - (errorFeeds / activeFeeds * 100)) : 0,
                avgResponseTime: 500, // Default estimate
                totalEvents: totalEvents,
                feedsChecked: activeFeeds,
                errorsResolved: 0,
                avgProcessingTime: 200, // Default estimate
                lastUpdate: new Date().toISOString()
            };
        },
        
        async addFeed() {
            this.isAdding = true;
            try {
                const response = await fetch('/api/rss-feeds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.newFeed)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.showAddFeedModal = false;
                    this.newFeed = { name: '', url: '', description: '', category: 'events', update_interval: 30 };
                    await this.loadFeeds();
                    this.showNotification('Feed added successfully!', 'success');
                } else {
                    this.showNotification(data.error || 'Error adding feed', 'error');
                }
            } catch (error) {
                this.showNotification('Error adding feed', 'error');
            } finally {
                this.isAdding = false;
            }
        },
        
        async refreshFeed(feedId) {
            this.isRefreshing = true;
            try {
                const response = await fetch(`/api/rss-feeds/${feedId}/refresh`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    await this.loadFeeds();
                    this.showNotification('Feed refreshed successfully!', 'success');
                } else {
                    this.showNotification(data.error || 'Error refreshing feed', 'error');
                }
            } catch (error) {
                this.showNotification('Error refreshing feed', 'error');
            } finally {
                this.isRefreshing = false;
            }
        },
        
        async refreshAllFeeds() {
            this.isRefreshing = true;
            try {
                const response = await fetch('/api/rss-feeds/refresh-all', {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    await this.loadFeeds();
                    this.showNotification('All feeds refreshed successfully!', 'success');
                } else {
                    this.showNotification(data.error || 'Error refreshing feeds', 'error');
                }
            } catch (error) {
                this.showNotification('Error refreshing feeds', 'error');
            } finally {
                this.isRefreshing = false;
            }
        },
        
        async editFeed(feed) {
            this.editingFeed = {
                id: feed.id,
                name: feed.name,
                url: feed.url,
                description: feed.description || '',
                category: feed.category || 'events',
                update_interval: feed.update_interval || 30,
                enabled: feed.is_active || feed.enabled
            };
            this.testResult = null;
            this.showEditFeedModal = true;
        },
        
        async updateFeed() {
            this.isUpdating = true;
            try {
                const response = await fetch(`/api/rss-feeds/${this.editingFeed.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(this.editingFeed)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    this.showEditFeedModal = false;
                    await this.loadFeeds();
                    this.showNotification('Feed updated successfully!', 'success');
                } else {
                    this.showNotification(data.error || 'Error updating feed', 'error');
                }
            } catch (error) {
                this.showNotification('Error updating feed', 'error');
            } finally {
                this.isUpdating = false;
            }
        },
        
        async testFeedUrl(url) {
            if (!url) return;
            
            this.isTestingUrl = true;
            this.testResult = null;
            
            try {
                const response = await fetch('/api/rss-feeds/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url })
                });
                
                const data = await response.json();
                this.testResult = data;
                
                if (data.success) {
                    this.showNotification('Feed test successful!', 'success');
                } else {
                    this.showNotification('Feed test failed: ' + data.message, 'error');
                }
            } catch (error) {
                this.testResult = {
                    success: false,
                    message: 'Error testing feed URL'
                };
                this.showNotification('Error testing feed URL', 'error');
            } finally {
                this.isTestingUrl = false;
            }
        },
        
        async testFeed(url) {
            await this.testFeedUrl(url);
        },
        
        toggleFeedSelection(feedId) {
            const index = this.selectedFeeds.indexOf(feedId);
            if (index > -1) {
                this.selectedFeeds.splice(index, 1);
            } else {
                this.selectedFeeds.push(feedId);
            }
        },
        
        async bulkEnable() {
            if (this.selectedFeeds.length === 0) return;
            
            try {
                const promises = this.selectedFeeds.map(feedId => 
                    fetch(`/api/rss-feeds/${feedId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enabled: true })
                    })
                );
                
                await Promise.all(promises);
                await this.loadFeeds();
                this.selectedFeeds = [];
                this.showNotification(`${this.selectedFeeds.length} feeds enabled successfully!`, 'success');
            } catch (error) {
                this.showNotification('Error enabling feeds', 'error');
            }
        },
        
        async bulkDisable() {
            if (this.selectedFeeds.length === 0) return;
            
            try {
                const promises = this.selectedFeeds.map(feedId => 
                    fetch(`/api/rss-feeds/${feedId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enabled: false })
                    })
                );
                
                await Promise.all(promises);
                await this.loadFeeds();
                this.selectedFeeds = [];
                this.showNotification(`${this.selectedFeeds.length} feeds disabled successfully!`, 'success');
            } catch (error) {
                this.showNotification('Error disabling feeds', 'error');
            }
        },
        
        async bulkRefresh() {
            if (this.selectedFeeds.length === 0) return;
            
            this.isRefreshing = true;
            try {
                const promises = this.selectedFeeds.map(feedId => 
                    fetch(`/api/rss-feeds/${feedId}/refresh`, { method: 'POST' })
                );
                
                await Promise.all(promises);
                await this.loadFeeds();
                this.selectedFeeds = [];
                this.showNotification(`${this.selectedFeeds.length} feeds refreshed successfully!`, 'success');
            } catch (error) {
                this.showNotification('Error refreshing feeds', 'error');
            } finally {
                this.isRefreshing = false;
            }
        },
        
        async bulkDelete() {
            if (this.selectedFeeds.length === 0) return;
            
            if (!confirm(`Are you sure you want to delete ${this.selectedFeeds.length} feeds?`)) return;
            
            try {
                const promises = this.selectedFeeds.map(feedId => 
                    fetch(`/api/rss-feeds/${feedId}`, { method: 'DELETE' })
                );
                
                await Promise.all(promises);
                await this.loadFeeds();
                this.selectedFeeds = [];
                this.showNotification(`${this.selectedFeeds.length} feeds deleted successfully!`, 'success');
            } catch (error) {
                this.showNotification('Error deleting feeds', 'error');
            }
        },
        
        async deleteFeed(feedId) {
            if (!confirm('Are you sure you want to delete this feed?')) return;
            
            try {
                const response = await fetch(`/api/rss-feeds/${feedId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await this.loadFeeds();
                    this.showNotification('Feed deleted successfully!', 'success');
                } else {
                    const data = await response.json();
                    this.showNotification(data.error || 'Error deleting feed', 'error');
                }
            } catch (error) {
                this.showNotification('Error deleting feed', 'error');
            }
        },
        
        async viewLogs(feedId) {
            try {
                const response = await fetch(`/api/rss-feeds/logs?feed_id=${feedId}&limit=50`);
                const data = await response.json();
                this.logs = data.logs;
                this.showLogsModal = true;
            } catch (error) {
                this.showNotification('Error loading logs', 'error');
            }
        },
        
        getStatusClass(feed) {
            if (!feed.is_active) return 'bg-gray-100 text-gray-800';
            if (feed.consecutive_failures > 0) return 'bg-red-100 text-red-800';
            if (feed.last_checked) return 'bg-green-100 text-green-800';
            return 'bg-yellow-100 text-yellow-800';
        },
        
        getStatusIcon(feed) {
            if (!feed.is_active) return 'fa-pause-circle';
            if (feed.consecutive_failures > 0) return 'fa-exclamation-triangle';
            if (feed.last_checked) return 'fa-check-circle';
            return 'fa-clock';
        },
        
        getStatusText(feed) {
            if (!feed.is_active) return 'Inactive';
            if (feed.consecutive_failures > 0) return 'Error';
            if (feed.last_checked) return 'Active';
            return 'Pending';
        },
        
        getLogStatusClass(status) {
            switch (status) {
                case 'success': return 'bg-green-100 text-green-800';
                case 'error': return 'bg-red-100 text-red-800';
                case 'warning': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        },
        
        formatDate(dateString) {
            if (!dateString) return 'Never';
            return new Date(dateString).toLocaleDateString();
        },
        
        formatDateTime(dateString) {
            if (!dateString) return 'Never';
            return new Date(dateString).toLocaleString();
        },
        
        getTimeAgo(dateString) {
            if (!dateString) return '';
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}d ago`;
        },
        
        getTopPerformingFeeds() {
            return this.feeds
                .filter(f => f.is_active)
                .sort((a, b) => (b.total_events || 0) - (a.total_events || 0))
                .slice(0, 3);
        },
        
        getFeedHealthScore(feed) {
            if (!feed.is_active) return 0;
            if (feed.consecutive_failures > 0) return Math.max(0, 100 - (feed.consecutive_failures * 20));
            return 100;
        },
        
        getHealthScoreClass(score) {
            if (score >= 80) return 'text-green-600';
            if (score >= 60) return 'text-yellow-600';
            return 'text-red-600';
        },
        
        getHealthScoreBgClass(score) {
            if (score >= 80) return 'bg-green-100';
            if (score >= 60) return 'bg-yellow-100';
            return 'bg-red-100';
        },
        
        getHealthScoreIconClass(score) {
            if (score >= 80) return 'text-green-600';
            if (score >= 60) return 'text-yellow-600';
            return 'text-red-600';
        },
        
        formatTimeAgo(dateString) {
            if (!dateString) return 'Never';
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}d ago`;
        },
        
        formatEventDate(dateString) {
            if (!dateString) return 'No date';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        async viewFeedEvents(feedId) {
            try {
                const response = await fetch(`/api/rss-feeds/${feedId}/events`);
                const data = await response.json();
                
                if (data.success) {
                    this.feedEvents = data.events || [];
                    this.selectedFeedName = data.feed_name || 'Unknown Feed';
                    this.showFeedEventsModal = true;
                } else {
                    this.showNotification(data.message || 'Failed to load events', 'error');
                }
            } catch (error) {
                console.error('Error loading feed events:', error);
                this.showNotification('Error loading events', 'error');
            }
        },
        
        showNotification(message, type = 'info') {
            // Create a toast notification
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-300 ease-in-out`;
            
            // Set colors based on type
            let bgColor = 'bg-blue-50';
            let textColor = 'text-blue-800';
            let iconColor = 'text-blue-400';
            let icon = 'fa-info-circle';
            
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-50';
                    textColor = 'text-green-800';
                    iconColor = 'text-green-400';
                    icon = 'fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-red-50';
                    textColor = 'text-red-800';
                    iconColor = 'text-red-400';
                    icon = 'fa-exclamation-circle';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-50';
                    textColor = 'text-yellow-800';
                    iconColor = 'text-yellow-400';
                    icon = 'fa-exclamation-triangle';
                    break;
            }
            
            notification.innerHTML = `
                <div class="p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="fas ${icon} ${iconColor}"></i>
                        </div>
                        <div class="ml-3 w-0 flex-1 pt-0.5">
                            <p class="text-sm font-medium ${textColor}">${message}</p>
                        </div>
                        <div class="ml-4 flex-shrink-0 flex">
                            <button class="bg-white rounded-md inline-flex ${textColor} hover:${textColor.replace('800', '600')} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" onclick="this.parentElement.parentElement.parentElement.parentElement.remove()">
                                <span class="sr-only">Close</span>
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        }
    }
}
</script>
{% endblock %}
