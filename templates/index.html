{% extends "base.html" %}

{% block title %}Calendar - Public View{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-3 sm:p-4 lg:p-6" x-data="calendarApp()">
    <!-- Header -->
    <div class="text-center mb-6 sm:mb-8">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-3 sm:space-y-0">
            <div class="order-2 sm:order-1">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Event Calendar</h1>
                <p class="text-sm sm:text-base text-gray-600">Click on a date to view events</p>
            </div>
            <div class="order-1 sm:order-2">
                <a href="/admin/login" 
                   class="bg-blue-600 text-white px-3 py-2 sm:px-4 sm:py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">
                    Admin Login
                </a>
            </div>
        </div>
    </div>

    <!-- Mini Calendar -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-4 sm:mb-6">
        <div class="flex justify-between items-center mb-4">
            <button @click="previousMonth()" class="p-2 sm:p-3 hover:bg-gray-100 rounded-full touch-manipulation">
                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <h2 class="text-lg sm:text-xl font-semibold text-gray-800" x-text="getCurrentMonthYear()"></h2>
            <button @click="nextMonth()" class="p-2 sm:p-3 hover:bg-gray-100 rounded-full touch-manipulation">
                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>

        <!-- Calendar Grid -->
        <div class="grid grid-cols-7 gap-0.5 sm:gap-1 mb-2">
            <div class="text-center text-xs sm:text-sm font-medium text-gray-500 py-1 sm:py-2">Sun</div>
            <div class="text-center text-xs sm:text-sm font-medium text-gray-500 py-1 sm:py-2">Mon</div>
            <div class="text-center text-xs sm:text-sm font-medium text-gray-500 py-1 sm:py-2">Tue</div>
            <div class="text-center text-xs sm:text-sm font-medium text-gray-500 py-1 sm:py-2">Wed</div>
            <div class="text-center text-xs sm:text-sm font-medium text-gray-500 py-1 sm:py-2">Thu</div>
            <div class="text-center text-xs sm:text-sm font-medium text-gray-500 py-1 sm:py-2">Fri</div>
            <div class="text-center text-xs sm:text-sm font-medium text-gray-500 py-1 sm:py-2">Sat</div>
        </div>

        <div class="grid grid-cols-7 gap-0.5 sm:gap-1">
            <template x-for="day in calendarDays" :key="day.date">
                <div class="relative">
                    <button 
                        @click="selectDate(day.date)"
                        :class="{
                            'bg-blue-500 text-white': day.isSelected,
                            'bg-gray-100': !day.isSelected && day.isCurrentMonth,
                            'text-gray-400': !day.isCurrentMonth,
                            'text-gray-800': day.isCurrentMonth && !day.isSelected
                        }"
                        class="w-full h-8 sm:h-10 rounded-lg text-xs sm:text-sm font-medium hover:bg-blue-100 transition-colors relative touch-manipulation min-h-[2rem] sm:min-h-[2.5rem]"
                        :disabled="!day.isCurrentMonth"
                    >
                        <span x-text="day.dayNumber"></span>
                        <div x-show="day.hasEvents" class="absolute bottom-0.5 sm:bottom-1 left-1/2 transform -translate-x-1/2 w-1 h-1 bg-blue-500 rounded-full"></div>
                    </button>
                </div>
            </template>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-4 sm:mb-6">
        <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4">üîç Search Events</h3>
        <div class="flex flex-col sm:flex-row gap-2">
            <input type="text" 
                   x-model="searchQuery" 
                   @input="performSearch()"
                   placeholder="Try: 'meetings next week', 'workshops in October', 'zoom calls on Friday'"
                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 sm:px-4 sm:py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base">
            <button @click="clearSearch()" 
                    x-show="searchQuery"
                    class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors text-sm sm:text-base touch-manipulation">
                Clear
            </button>
        </div>
        <div x-show="searchResults.length > 0" class="mt-4">
            <p class="text-sm text-gray-600 mb-2">
                Found <span x-text="searchResults.length"></span> event(s) for "<span x-text="searchQuery"></span>"
            </p>
        </div>
    </div>

    <!-- Subscriptions Panel -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-4 sm:mb-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 space-y-2 sm:space-y-0">
            <h3 class="text-base sm:text-lg font-semibold text-gray-800">üîî My Subscriptions</h3>
            <button @click="showSubscriptionModal = true" 
                    class="px-3 py-2 sm:px-4 sm:py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm touch-manipulation">
                Manage
            </button>
        </div>
        
        <div x-show="subscriptions.event.length === 0 && subscriptions.host.length === 0 && subscriptions.venue.length === 0 && subscriptions.tag.length === 0" 
             class="text-center py-4 text-gray-500">
            <p>No subscriptions yet. Click "Manage" to follow events, hosts, venues, or tags!</p>
        </div>
        
        <div x-show="subscriptions.event.length > 0 || subscriptions.host.length > 0 || subscriptions.venue.length > 0 || subscriptions.tag.length > 0" 
             class="space-y-3">
            <div x-show="subscriptions.event.length > 0" class="flex flex-wrap gap-2">
                <span class="text-sm font-medium text-gray-600">Events:</span>
                <template x-for="eventId in subscriptions.event" :key="eventId">
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">
                        Event #<span x-text="eventId"></span>
                    </span>
                </template>
            </div>
            
            <div x-show="subscriptions.host.length > 0" class="flex flex-wrap gap-2">
                <span class="text-sm font-medium text-gray-600">Hosts:</span>
                <template x-for="host in subscriptions.host" :key="host">
                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs" x-text="host"></span>
                </template>
            </div>
            
            <div x-show="subscriptions.venue.length > 0" class="flex flex-wrap gap-2">
                <span class="text-sm font-medium text-gray-600">Venues:</span>
                <template x-for="venue in subscriptions.venue" :key="venue">
                    <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs" x-text="venue"></span>
                </template>
            </div>
            
            <div x-show="subscriptions.tag.length > 0" class="flex flex-wrap gap-2">
                <span class="text-sm font-medium text-gray-600">Tags:</span>
                <template x-for="tag in subscriptions.tag" :key="tag">
                    <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs" x-text="tag"></span>
                </template>
            </div>
        </div>
    </div>

    <!-- Events List -->
    <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
        <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4" x-text="searchQuery ? 'Search Results' : selectedDateText"></h3>
        
        <div x-show="loading || searchLoading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <p class="mt-2 text-gray-600" x-text="searchLoading ? 'Searching...' : 'Loading...'"></p>
        </div>

        <div x-show="!loading && !searchLoading && !searchQuery && events.length === 0" class="text-center py-8 text-gray-500">
            No events scheduled for this date.
        </div>

        <div x-show="!loading && !searchLoading && searchQuery && searchResults.length === 0" class="text-center py-8 text-gray-500">
            No events found for your search.
        </div>

        <div x-show="!loading && !searchLoading && (searchQuery ? searchResults.length > 0 : events.length > 0)" class="space-y-3 sm:space-y-4">
            <template x-for="event in (searchQuery ? searchResults : events)" :key="event.id">
                <div class="border-l-4 pl-3 sm:pl-4 py-2 sm:py-3" :style="'border-left-color: ' + (event.category_color || '#3B82F6')">
                    <div class="flex flex-col sm:flex-row justify-between items-start space-y-2 sm:space-y-0">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-1 sm:gap-2 flex-wrap">
                                <h4 class="font-medium text-gray-800 text-sm sm:text-base" x-text="event.title"></h4>
                                <span x-show="event.category_name" 
                                      class="px-2 py-1 text-xs font-medium rounded-full text-white"
                                      :style="'background-color: ' + (event.category_color || '#3B82F6')"
                                      x-text="event.category_name"></span>
                                <template x-for="tag in getEventTags(event)" :key="tag">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-200 text-gray-700"
                                          x-text="tag"></span>
                                </template>
                                <span x-show="isImportantEvent(event)" 
                                      class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700">
                                    ‚≠ê Important
                                </span>
                            </div>
                            <p class="text-xs sm:text-sm text-gray-600" x-text="formatEventTime(event.start_datetime)"></p>
                            <p x-show="event.location" class="text-xs sm:text-sm text-gray-500" x-text="'üìç ' + event.location"></p>
                            <p x-show="event.host" class="text-xs sm:text-sm text-gray-500" x-text="'üë§ ' + event.host"></p>
                            <p x-show="event.price_info" class="text-xs sm:text-sm font-medium" 
                               :class="event.price_info === 'Free' ? 'text-green-600' : 'text-blue-600'"
                               x-text="'üí∞ ' + event.price_info"></p>
                            <p x-show="event.description" class="text-xs sm:text-sm text-gray-600 mt-1" x-text="event.description"></p>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-1 sm:gap-2 flex-wrap">
                            <button @click="subscribeToEvent(event.id)" 
                                    x-show="!subscriptions.event.includes(event.id)"
                                    class="px-2 py-1 sm:px-3 sm:py-1 bg-blue-100 text-blue-700 rounded-full text-xs hover:bg-blue-200 transition-colors touch-manipulation">
                                üîî Follow Event
                            </button>
                            <button @click="unsubscribeFromEvent(event.id)" 
                                    x-show="subscriptions.event.includes(event.id)"
                                    class="px-2 py-1 sm:px-3 sm:py-1 bg-gray-100 text-gray-700 rounded-full text-xs hover:bg-gray-200 transition-colors touch-manipulation">
                                ‚úÖ Following
                            </button>
                            <button @click="subscribeToHost(event.host)" 
                                    x-show="event.host && !subscriptions.host.includes(event.host)"
                                    class="px-2 py-1 sm:px-3 sm:py-1 bg-green-100 text-green-700 rounded-full text-xs hover:bg-green-200 transition-colors touch-manipulation">
                                ‚≠ê Follow Host
                            </button>
                            <button @click="subscribeToVenue(event.location)" 
                                    x-show="event.location && !subscriptions.venue.includes(event.location)"
                                    class="px-2 py-1 sm:px-3 sm:py-1 bg-purple-100 text-purple-700 rounded-full text-xs hover:bg-purple-200 transition-colors touch-manipulation">
                                üè¢ Follow Venue
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- Subscription Management Modal -->
    <div x-show="showSubscriptionModal" 
         x-cloak
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
         @click.self="showSubscriptionModal = false">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">üîî Manage Subscriptions</h3>
                
                <!-- Subscription Suggestions -->
                <div class="space-y-4">
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Available Hosts</h4>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="host in subscriptionSuggestions.hosts" :key="host">
                                <button @click="toggleHostSubscription(host)"
                                        :class="subscriptions.host.includes(host) ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-700'"
                                        class="px-2 py-1 rounded-full text-xs hover:opacity-80 transition-colors">
                                    <span x-text="host"></span>
                                    <span x-show="subscriptions.host.includes(host)"> ‚úì</span>
                                </button>
                            </template>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Available Venues</h4>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="venue in subscriptionSuggestions.venues" :key="venue">
                                <button @click="toggleVenueSubscription(venue)"
                                        :class="subscriptions.venue.includes(venue) ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-700'"
                                        class="px-2 py-1 rounded-full text-xs hover:opacity-80 transition-colors">
                                    <span x-text="venue"></span>
                                    <span x-show="subscriptions.venue.includes(venue)"> ‚úì</span>
                                </button>
                            </template>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Available Tags</h4>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="tag in subscriptionSuggestions.tags" :key="tag">
                                <button @click="toggleTagSubscription(tag)"
                                        :class="subscriptions.tag.includes(tag) ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-700'"
                                        class="px-2 py-1 rounded-full text-xs hover:opacity-80 transition-colors">
                                    <span x-text="tag"></span>
                                    <span x-show="subscriptions.tag.includes(tag)"> ‚úì</span>
                                </button>
                            </template>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showSubscriptionModal = false"
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function calendarApp() {
    return {
        currentDate: new Date(),
        monthYearDisplay: new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
        selectedDate: null,
        events: [],
        loading: false,
        eventsByDate: {},
        searchQuery: '',
        searchResults: [],
        searchLoading: false,
        searchTimeout: null,
        showSubscriptionModal: false,
        subscriptions: {
            event: [],
            host: [],
            venue: [],
            tag: []
        },
        subscriptionSuggestions: {
            hosts: [],
            venues: [],
            tags: []
        },


        get selectedDateText() {
            if (!this.selectedDate) return 'Select a date to view events';
            return this.selectedDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        },

        get calendarDays() {
            const year = this.currentDate.getFullYear();
            const month = this.currentDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const days = [];
            const today = new Date();
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dateStr = this.formatDate(date);
                const hasEvents = this.eventsByDate[dateStr] && this.eventsByDate[dateStr].length > 0;
                
                days.push({
                    date: dateStr,
                    dayNumber: date.getDate(),
                    isCurrentMonth: date.getMonth() === month,
                    isSelected: this.selectedDate && this.formatDate(this.selectedDate) === dateStr,
                    hasEvents: hasEvents
                });
            }
            
            return days;
        },

        init() {
            // Initialize month display
            this.updateMonthDisplay();
            this.loadEventsForMonth();
            this.loadSubscriptions();
            this.loadSubscriptionSuggestions();
        },
        
        getCurrentMonthYear() {
            // This method is called by Alpine.js and will trigger reactivity
            const display = this.currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            console.log('getCurrentMonthYear called, returning:', display);
            return display;
        },
        
        updateMonthDisplay() {
            // Keep this for backward compatibility and debugging
            const newDisplay = this.currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            this.monthYearDisplay = newDisplay;
            console.log('Month display updated to:', newDisplay);
        },

        async loadEventsForMonth() {
            const year = this.currentDate.getFullYear();
            const month = this.currentDate.getMonth() + 1;
            
            try {
                const response = await fetch(`/api/events?month=${month}&year=${year}`);
                const events = await response.json();
                
                this.eventsByDate = {};
                events.forEach(event => {
                    const date = new Date(event.start_datetime);
                    const dateStr = this.formatDate(date);
                    if (!this.eventsByDate[dateStr]) {
                        this.eventsByDate[dateStr] = [];
                    }
                    this.eventsByDate[dateStr].push(event);
                });
            } catch (error) {
                console.error('Error loading events:', error);
            }
        },

        async selectDate(dateStr) {
            this.selectedDate = new Date(dateStr);
            this.loading = true;
            
            try {
                const response = await fetch(`/api/events?date=${dateStr}`);
                this.events = await response.json();
            } catch (error) {
                console.error('Error loading events for date:', error);
                this.events = [];
            } finally {
                this.loading = false;
            }
        },

        async performSearch() {
            // Clear previous timeout
            if (this.searchTimeout) {
                clearTimeout(this.searchTimeout);
            }
            
            // Set new timeout for debounced search
            this.searchTimeout = setTimeout(async () => {
                if (!this.searchQuery.trim()) {
                    this.searchResults = [];
                    return;
                }
                
                this.searchLoading = true;
                
                try {
                    const response = await fetch(`/api/events/search?q=${encodeURIComponent(this.searchQuery)}`);
                    this.searchResults = await response.json();
                } catch (error) {
                    console.error('Error searching events:', error);
                    this.searchResults = [];
                } finally {
                    this.searchLoading = false;
                }
            }, 300); // 300ms debounce
        },

        clearSearch() {
            if (this.searchTimeout) {
                clearTimeout(this.searchTimeout);
            }
            this.searchQuery = '';
            this.searchResults = [];
        },

        async previousMonth() {
            try {
                // Create new Date object to trigger Alpine.js reactivity
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 1);
                this.updateMonthDisplay();
                await this.loadEventsForMonth();
                
                // Clear selected date if it's not in the new month
                if (this.selectedDate && this.selectedDate.getMonth() !== this.currentDate.getMonth()) {
                    this.selectedDate = null;
                    this.selectedDateEvents = [];
                }
            } catch (error) {
                console.error('Error navigating to previous month:', error);
            }
        },

        async nextMonth() {
            try {
                // Create new Date object to trigger Alpine.js reactivity
                this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 1);
                this.updateMonthDisplay();
                await this.loadEventsForMonth();
                
                // Clear selected date if it's not in the new month
                if (this.selectedDate && this.selectedDate.getMonth() !== this.currentDate.getMonth()) {
                    this.selectedDate = null;
                    this.selectedDateEvents = [];
                }
            } catch (error) {
                console.error('Error navigating to next month:', error);
            }
        },

        formatDate(date) {
            return date.toISOString().split('T')[0];
        },

        formatEventTime(datetime) {
            const date = new Date(datetime);
            return date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        },

        getEventTags(event) {
            if (!event.tags) return [];
            try {
                return JSON.parse(event.tags);
            } catch {
                return [];
            }
        },

        isImportantEvent(event) {
            const title = (event.title || '').toLowerCase();
            const tags = this.getEventTags(event);
            
            // Check for important keywords
            const importantWords = ['launch', 'keynote', 'deadline', 'urgent', 'critical', 'important'];
            if (importantWords.some(word => title.includes(word))) {
                return true;
            }
            
            // Check for important tags
            if (tags.includes('Important') || tags.includes('Launch')) {
                return true;
            }
            
            return false;
        },

        // Subscription Management
        loadSubscriptions() {
            const stored = localStorage.getItem('calendar_subscriptions');
            if (stored) {
                try {
                    this.subscriptions = JSON.parse(stored);
                } catch (e) {
                    console.error('Error loading subscriptions:', e);
                }
            }
        },

        saveSubscriptions() {
            localStorage.setItem('calendar_subscriptions', JSON.stringify(this.subscriptions));
        },

        async loadSubscriptionSuggestions() {
            try {
                const response = await fetch('/api/subscriptions/suggestions');
                if (response.ok) {
                    this.subscriptionSuggestions = await response.json();
                }
            } catch (error) {
                console.error('Error loading subscription suggestions:', error);
            }
        },

        subscribeToEvent(eventId) {
            if (!this.subscriptions.event.includes(eventId)) {
                this.subscriptions.event.push(eventId);
                this.saveSubscriptions();
            }
        },

        unsubscribeFromEvent(eventId) {
            this.subscriptions.event = this.subscriptions.event.filter(id => id !== eventId);
            this.saveSubscriptions();
        },

        subscribeToHost(host) {
            if (host && !this.subscriptions.host.includes(host)) {
                this.subscriptions.host.push(host);
                this.saveSubscriptions();
            }
        },

        subscribeToVenue(venue) {
            if (venue && !this.subscriptions.venue.includes(venue)) {
                this.subscriptions.venue.push(venue);
                this.saveSubscriptions();
            }
        },

        subscribeToTag(tag) {
            if (tag && !this.subscriptions.tag.includes(tag)) {
                this.subscriptions.tag.push(tag);
                this.saveSubscriptions();
            }
        },

        toggleHostSubscription(host) {
            if (this.subscriptions.host.includes(host)) {
                this.subscriptions.host = this.subscriptions.host.filter(h => h !== host);
            } else {
                this.subscriptions.host.push(host);
            }
            this.saveSubscriptions();
        },

        toggleVenueSubscription(venue) {
            if (this.subscriptions.venue.includes(venue)) {
                this.subscriptions.venue = this.subscriptions.venue.filter(v => v !== venue);
            } else {
                this.subscriptions.venue.push(venue);
            }
            this.saveSubscriptions();
        },

        toggleTagSubscription(tag) {
            if (this.subscriptions.tag.includes(tag)) {
                this.subscriptions.tag = this.subscriptions.tag.filter(t => t !== tag);
            } else {
                this.subscriptions.tag.push(tag);
            }
            this.saveSubscriptions();
        }
    }
}
</script>
{% endblock %}
